MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;**********************************************************************
                      00002 ;  Filename: OBD2                                                     *
                      00003 ;  Uses PIC16F876A                                                    *
                      00004 ;  Date: 13.05.2018                                                   *
                      00005 ;  Author:  Jose Jesus                                                *
                      00006 ;                                                                     *
                      00007 ;  Uses:
                      00008 ;        
                      00009 ;                                                                     *
                      00010 ;        RC2004A  20*4 Display interface
                      00011 ;        MCP2515  CAN Controller
                      00012 ;        MCP2551  CAN Transceiver
                      00013 ;        MAX232   USART data manager
                      00014 ;                                                                     *
                      00015 ;  10 MHz Osc                                                         *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;                                                                     *
                      00020 ; Tosc = (1/10 MHz)   = 0.0000001s = 100ns                            *
                      00021 ; 1 instruction  = TOsc * 4 = 400ns                                   *
                      00022 ;
                      00023 ; Tosc = (1/4  MHz)   = 0.00000025s = 250ns                           *
                      00024 ; 1 instruction  = TOsc * 4 = 1us                                     *
                      00025 ;
                      00026 ;
                      00027 ;                                                                     *
                      00028 ;                                                                     *
                      00029 ;**********************************************************************
                      00030 ;                                                                     *
                      00031 ;**********************************************************************
                      00032 ;                                                                     *                                 
                               
                      00033 ;    Pin assignments:                                                 *                                 
                               
                      00034 ;     2 - RA0-0             = D7 Display                              *                                 
                      00035 ;     3 - RA1-0             = D6 Display         
                      00036 ;     4 - RA2-0             = D5 Display                              *                                 
                             
                      00037 ;     5 - RA3-0             = D4 Display                              *
                      00038 ;     6 - RA4-0             = EN Display                              *
                      00039 ;     7 - RA5-0             = RS Display                              *
                      00040 ;    21 - RB0-1             =  INT CAN                             *
                      00041 ;    22 - RB1-1             =  button left          !!                    *
                      00042 ;    23 - RB2-1             =  button up                            *
                      00043 ;    24 - RB3-1             =  Button right                             *
                      00044 ;    25 - RB4-1             =  Button down                            *                                
                      00045 ;    26 - RB5-1             =  Button enter                           *
                      00046 ;    27 - RB6-1             =                            *
                      00047 ;    28 - RB7-1             =                             *
                      00048 ;    11 - RC0-1             = 
                      00049 ;    12 - RC1-0             =                           *
                      00050 ;    13 - RC2-0             = CS  CAN 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00051 ;    14 - RC3-0             = SCK CAN 
                      00052 ;    15 - RC4-0             = SO  CAN
                      00053 ;    16 - RC5-O             = SI  CAN                               *
                      00054 ;    17 - RC6- TX           =                        *
                      00055 ;    18 - RC7- RX           =                       *
                      00056 ;
                      00057 ;                                                                     *
                      00058 ;                                                                     *
                      00059 ;*************************************************************************
                      00060 
                      00061 
                      00062 
                      00063 
                      00064 
                      00065 
                      00066 ;***** COMPILATION MESSAGES & WARNINGS *****
                      00067 
                      00068         ERRORLEVEL -207         ; Found label after column 1.
                      00069         ERRORLEVEL -302         ; Register in operand not in bank 0.
                      00070 ;    ERRORLEVEL -305     ; using default destination
                      00071 ;***** PROCESSOR DECLARATION & CONFIGURATION *****
                      00072 
                      00073 
                      00074 
  00000001            00075 dVersion equ 1
  00000000            00076 dRelease equ 0
                      00077 
                      00078 
                      00079         PROCESSOR 16F876a
                      00080     
                      00081  
                      00082     LIST r=dec, x=on, t=off  
                      00083 
                      00084         #include "p16f876a.inc"
                      00001         LIST
                      00002 ; P16F876A.INC  Standard Header File, Version 1.00    Microchip Technology, Inc.
                      00384         LIST
                      00085     
                      00086    #include "MACROS16.inc"
                      00001 
                      00002 
                      00003 ;www.pudn.com > MCP2510com.rar.zip > MACROS16.INC, change:1999-02-16,size:8333b
                      00004  
                      00005 
                      00006 ;Basic macros for PIC16C series 
                      00007 ;6/20/98 
                      00008  
                      00009 #ifdef __16C77 
                      00010 #define _COMMONBANK  ; use common upper 16 bytes in 4 banks 
                      00011 #endif 
                      00012 #ifdef __16C76 
                      00013 #define _COMMONBANK  ; use common upper 16 bytes in 4 banks 
                      00014 #endif 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00015  
  00000001            00016 TRUE            equ     1 
  00000000            00017 FALSE           equ     0   
                      00018  
                      00019 ; Page 1 register definitions to avoid page warning 
                      00020  
                      00021 ;OPTION_REG_P                 EQU     H'0081'-0x80 
                      00022 ;TRISA_P                      EQU     H'0085'-0x80 
                      00023 ;TRISB_P                      EQU     H'0086'-0x80 
                      00024 ;TRISC_P                      EQU     H'0087'-0x80 
                      00025 ;TRISD_P                      EQU     H'0088'-0x80 
                      00026 ;TRISE_P                      EQU     H'0089'-0x80 
  0000008C            00027 PIE1_P                       EQU     H'008C';-0x80 
                      00028 ;PIE2_P                       EQU     H'008D'-0x80 
                      00029 ;PCON_P                       EQU     H'008E'-0x80 
                      00030 ;PR2_P                        EQU     H'0092'-0x80 
                      00031 ;SSPADD_P                     EQU     H'0093'-0x80 
                      00032 ;SSPSTAT_P                    EQU     H'0094'-0x80 
                      00033 ;TXSTA_P                      EQU     H'0098'-0x80 
                      00034 ;SPBRG_P                      EQU     H'0099'-0x80 
                      00035 ;ADCON1_P                     EQU     H'009F'-0x80 
                      00036  
                      00037  
                      00038  
                      00039 ; Special register bit definition pairs 
                      00040  
                      00041 ;     STATUS bit definitions 
                      00042  
                      00043 #define _C              STATUS,0 
                      00044 #define _DC             STATUS,1 
                      00045 #define _Z              STATUS,2 
                      00046 #define _PD             STATUS,3 
                      00047 #define _TO             STATUS,4 
                      00048 #define _RP0            STATUS,5 
                      00049 #define _RP1            STATUS,6 
                      00050 #define _IRP            STATUS,7 
                      00051  
                      00052  
                      00053 #define _INTE       INTCON,INTE   ; External interrupt enable  
                      00054 #define _INTF       INTCON,INTF   ; External interrupt flag 
                      00055 #define _RBIE       INTCON,RBIE   ; Port B pins 4-7 edge interrupt enable  
                      00056 #define _RBIF       INTCON,RBIF   ; Port B pins 4-7 edge interrupt flag 
                      00057 #define _T0IE       INTCON,T0IE   ; Timer 0 interrupt enable  
                      00058 #define _T0IF       INTCON,T0IF   ; Timer 0 interrupt flag 
                      00059  
                      00060 #define _CCP1IE_P   PIE1_P,CCP1IE ; Timer 1 compare int enable (page 1) 
                      00061 #define _CCP1IF     PIR1,CCP1IF   ; Timer 1 compare int flag 
                      00062  
                      00063 #define _RCIE_P     PIE1_P,RCIE   ; async rec interrupt enable (page 1) 
                      00064 #define _RCIF       PIR1,RCIF     ; async rec interrupt flag 
                      00065  
                      00066 #define _TXIE_P     PIE1_P,TXIE   ; async xmit interrupt enable (page 1) 
                      00067 #define _TXIF       PIR1,TXIF     ; async xmit interrupt flag 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00068  
                      00069 #define _SSPIE_P    PIE1_P,SSPIE  ; SSP int enable (page 1) 
                      00070 #define _SSPIF      PIR1,SSPIF    ; SSP interrupt flag 
                      00071  
                      00072 #define _TMR1IE_P   PIE1_P,TMR1IE ; Timer 1 enable (page 1) 
                      00073 #define _TMR1IF     PIR1,TMR1IF   ; Timer1 interrupt flag 
                      00074  
                      00075 #define _TMR2IE_P   PIE1_P,TMR2IE ; Timer 2 enable (page 1) 
                      00076 #define _TMR2IF     PIR1,TMR2IF   ; Timer2 interrupt flag 
                      00077  
                      00078 #ifdef _COMMONBANK ; use common upper 16 bytes in 4 banks 
                      00079  
                      00080 PAGE3   macro    
                      00081         bsf     PCLATH,4 
                      00082         bsf     PCLATH,3 
                      00083         endm 
                      00084  
                      00085 PAGE2   macro 
                      00086         bsf     PCLATH,4 
                      00087         bcf     PCLATH,3 
                      00088         endm 
                      00089  
                      00090 PAGE1   macro    
                      00091         bcf     PCLATH,4 
                      00092         bsf     PCLATH,3 
                      00093         endm 
                      00094  
                      00095 PAGE0   macro 
                      00096         bcf     PCLATH,4 
                      00097         bcf     PCLATH,3 
                      00098         endm 
                      00099  
                      00100  
                      00101 BANK3   macro 
                      00102         bsf     STATUS,6 
                      00103         bsf     STATUS,5 
                      00104         endm 
                      00105  
                      00106 BANK2   macro 
                      00107         bsf     STATUS,6 
                      00108         bcf     STATUS,5 
                      00109         endm 
                      00110  
                      00111 BANK1   macro 
                      00112         bcf     STATUS,6 
                      00113         bsf     STATUS,5 
                      00114         endm 
                      00115  
                      00116 BANK0   macro 
                      00117         bcf     STATUS,6 
                      00118         bcf     STATUS,5 
                      00119         endm 
                      00120  
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00121  
                      00122 FSRBank23 macro 
                      00123         bsf     STATUS,7 
                      00124         endm 
                      00125  
                      00126 FSRBank01 macro 
                      00127         bcf     STATUS,7 
                      00128         endm 
                      00129 #else 
                      00130  
                      00131  
                      00132 PAGE1   macro    
                      00133         bsf     PCLATH,3 
                      00134         endm 
                      00135  
                      00136 PAGE0   macro 
                      00137         bcf     PCLATH,3 
                      00138         endm 
                      00139  
                      00140 BANK0   macro 
                      00141         bcf     STATUS,5    ; Select page 0 
                      00142         endm 
                      00143  
                      00144 BANK1   macro 
                      00145         bsf     STATUS,5    ; Select page 1 
                      00146         endm 
                      00147 #endif 
                      00148  
                      00149 enableInt macro 
                      00150         bsf     INTCON,GIE 
                      00151         endm 
                      00152  
                      00153 disableInt macro 
                      00154           local    Loop 
                      00155 Loop    bcf     INTCON,GIE 
                      00156         btfsc   INTCON,GIE 
                      00157         goto    Loop 
                      00158         endm 
                      00159  
                      00160  
                      00161  
                      00162 ; Byte logical & arithmetic macros 
                      00163  
                      00164 bV2bV   macro   bSource,bDest 
                      00165         movf    bSource,W 
                      00166         movwf   bDest 
                      00167          endm 
                      00168  
                      00169 bL2bV   macro   bVal,bDest 
                      00170         movlw   bVal 
                      00171         movwf   bDest 
                      00172         endm 
                      00173  
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00174 jmpFeqZ macro   Reg,Label 
                      00175         movf    Reg,F 
                      00176         btfsc   _Z 
                      00177         goto    Label 
                      00178         endm 
                      00179  
                      00180 jmpFneZ macro   Reg,Label 
                      00181         movf    Reg,F 
                      00182         btfss   _Z 
                      00183         goto    Label 
                      00184         endm 
                      00185  
                      00186 jmpFgtL macro   Reg1,bVal,Label 
                      00187           movfw     Reg1 
                      00188           jmpWgtL   bVal,Label 
                      00189         endm 
                      00190  
                      00191 jmpFgeL macro   Reg1,bVal,Label 
                      00192           movfw     Reg1 
                      00193           jmpWgeL   bVal,Label 
                      00194         endm 
                      00195  
                      00196 jmpFeqL macro   Reg,bVal,Label 
                      00197         movf    Reg,W 
                      00198           sublw   bVal 
                      00199         btfsc   _Z 
                      00200         goto    Label 
                      00201         endm 
                      00202  
                      00203 jmpFneL macro   Reg,bVal,Label 
                      00204         movf    Reg,W 
                      00205           sublw   bVal 
                      00206           btfss   _Z 
                      00207           goto    Label 
                      00208           endm 
                      00209  
                      00210 jmpFleL macro   Reg1,bVal,Label 
                      00211           movfw     Reg1 
                      00212           jmpWleL   bVal,Label 
                      00213         endm 
                      00214  
                      00215 jmpFltL macro   Reg1,bVal,Label 
                      00216           movfw     Reg1 
                      00217           jmpWltL   bVal,Label 
                      00218         endm 
                      00219  
                      00220 jmpFeqF macro   Reg1,Reg2,Label 
                      00221         movf    Reg1,W 
                      00222         subwf   Reg2,W 
                      00223         btfsc   _Z 
                      00224         goto    Label 
                      00225         endm 
                      00226  
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00227 jmpFneF macro   Reg1,Reg2,Label 
                      00228         movf    Reg1,W 
                      00229         subwf   Reg2,W 
                      00230         btfss   _Z 
                      00231         goto    Label 
                      00232         endm 
                      00233  
                      00234 jmpFleF macro   Reg1,Reg2,Label 
                      00235           movfw     Reg1 
                      00236           jmpWleF   Reg2,Label 
                      00237         endm 
                      00238  
                      00239 jmpFltF macro   Reg1,Reg2,Label 
                      00240           movfw     Reg1 
                      00241           jmpWltF   Reg2,Label 
                      00242         endm 
                      00243  
                      00244 jmpWeqZ macro   Label        ; jmp if W == 0 
                      00245         andlw   0xFF 
                      00246         jmpZ    Label 
                      00247         endm 
                      00248  
                      00249 jmpWneZ macro   Label        ; jmp if W != 0 
                      00250         andlw   0xFF 
                      00251         jmpNZ   Label 
                      00252         endm 
                      00253  
                      00254 skipFeqZ macro   Reg 
                      00255         movf    Reg,F 
                      00256         btfss   _Z 
                      00257         endm 
                      00258  
                      00259 skipFneZ macro   Reg 
                      00260         movf    Reg,F 
                      00261         btfsc   _Z 
                      00262         endm 
                      00263  
                      00264 skipFeqL macro   Reg,bVal 
                      00265         movf    Reg,W 
                      00266         sublw   bVal 
                      00267         btfss   _Z 
                      00268         endm 
                      00269  
                      00270 skipFneL macro   Reg,bVal 
                      00271         movf    Reg,W 
                      00272         sublw   bVal 
                      00273         btfsc   _Z 
                      00274         endm 
                      00275  
                      00276 skipFeqF macro   Reg1,Reg2 
                      00277         movf    Reg1,W 
                      00278         subwf   Reg2,W 
                      00279         btfss   _Z 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00280         endm 
                      00281  
                      00282 skipFneF macro   Reg1,Reg2 
                      00283         movf    Reg1,W 
                      00284         subwf   Reg2,W 
                      00285         btfsc   _Z 
                      00286         endm 
                      00287  
                      00288 skipWeqZ macro 
                      00289         andlw   0xFF 
                      00290         btfss   _Z 
                      00291         endm 
                      00292  
                      00293 skipWneZ macro 
                      00294         andlw   0xFF 
                      00295         btfsc   _Z 
                      00296         endm 
                      00297  
                      00298 jmpWgtL macro   bVal,Label 
                      00299         sublw   bVal 
                      00300         btfss   _C 
                      00301         goto    Label 
                      00302         endm 
                      00303  
                      00304 jmpWgeL macro   bVal,Label 
                      00305         sublw   bVal 
                      00306         btfss   _C 
                      00307         goto    Label 
                      00308         btfsc   _Z 
                      00309         goto    Label 
                      00310         endm 
                      00311  
                      00312 jmpWeqL macro   bVal,Label 
                      00313         sublw   bVal 
                      00314         btfsc   _Z 
                      00315         goto    Label 
                      00316         endm 
                      00317  
                      00318 jmpWneL macro   bVal,Label 
                      00319         sublw   bVal 
                      00320         btfss   _Z 
                      00321         goto    Label 
                      00322         endm 
                      00323  
                      00324 jmpWleL macro   bVal,Label 
                      00325         sublw   bVal 
                      00326         btfsc   _C 
                      00327         goto    Label 
                      00328         endm 
                      00329  
                      00330 jmpWltL macro   bVal,Label 
                      00331         sublw   bVal 
                      00332         skipC 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00333         bsf     _Z 
                      00334         jmpNZ   Label 
                      00335         endm 
                      00336  
                      00337 jmpWgtF macro   Reg,Label 
                      00338         subwf   Reg,W 
                      00339         btfss   _C 
                      00340         goto    Label 
                      00341         endm 
                      00342  
                      00343 jmpWgeF macro   Reg,Label 
                      00344         subwf   Reg,W 
                      00345         btfss   _C 
                      00346         goto    Label 
                      00347         btfsc   _Z 
                      00348         goto    Label 
                      00349         endm 
                      00350  
                      00351 jmpWeqF macro   Reg,Label 
                      00352         subwf   Reg,W 
                      00353         btfsc   _Z 
                      00354         goto    Label 
                      00355         endm 
                      00356  
                      00357 jmpWneF macro   Reg,Label 
                      00358         subwf   Reg,W 
                      00359         btfss   _Z 
                      00360         goto    Label 
                      00361         endm 
                      00362  
                      00363 jmpWleF macro   Reg,Label 
                      00364         subwf   Reg,W 
                      00365         btfsc   _C 
                      00366         goto    Label 
                      00367         endm 
                      00368  
                      00369 jmpWltF macro   Reg,Label 
                      00370         subwf   Reg,W 
                      00371         skipC 
                      00372         bsf     _Z 
                      00373         jmpNZ   Label 
                      00374         endm 
                      00375  
                      00376  
                      00377 jmpClr  macro Reg,Bit,Label 
                      00378  
                      00379         btfss   Reg,Bit 
                      00380         goto    Label 
                      00381         endm 
                      00382  
                      00383 jmpSet  macro Reg,Bit,Label 
                      00384         btfsc   Reg,Bit 
                      00385         goto    Label 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00386         endm 
                      00387  
                      00388 jmpZ    macro Label 
                      00389         btfsc   _Z 
                      00390         goto    Label 
                      00391         endm 
                      00392  
                      00393 jmpNZ   macro Label 
                      00394         btfss   _Z 
                      00395         goto    Label 
                      00396         endm 
                      00397  
                      00398 jmpC    macro Label 
                      00399         btfsc   _C 
                      00400         goto    Label 
                      00401         endm 
                      00402  
                      00403 jmpNC   macro Label 
                      00404         btfss   _C 
                      00405         goto    Label 
                      00406         endm 
                      00407  
                      00408 skipClr macro Reg,Bit 
                      00409         btfsc   Reg,Bit 
                      00410         endm 
                      00411  
                      00412 skipSet macro Reg,Bit 
                      00413         btfss   Reg,Bit 
                      00414         endm 
                      00415  
                      00416 skipNZ  macro 
                      00417         btfsc   _Z 
                      00418         endm 
                      00419  
                      00420 skipZ   macro 
                      00421         btfss   _Z 
                      00422         endm 
                      00423  
                      00424 skipNC  macro 
                      00425         btfsc   _C 
                      00426         endm 
                      00427  
                      00428 skipC   macro 
                      00429         btfss   _C 
                      00430         endm 
                      00431  
                      00432 toggle  macro Reg,Bit 
                      00433         local    SLabel,Label 
                      00434         btfss   Reg,Bit 
                      00435         goto    SLabel 
                      00436         bcf     Reg,Bit 
                      00437         goto    Label 
                      00438 SLabel  bsf     Reg,Bit 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00439 Label    
                      00440         endm         
                      00441  
                      00442  
                      00443 tb2tb macro RegS,BitS,RegD,BitD 
                      00444           local     jLab1,jLab2 
                      00445           jmpSet    RegS,BitS,jLab1 
                      00446           bcf       RegD,BitD 
                      00447           goto      jLab2 
                      00448 jLab1     bsf       RegD,BitD 
                      00449 jLab2 
                      00450           endm 
                      00451  
                      00452 tb2Nottb macro RegS,BitS,RegD,BitD 
                      00453           local     jLab1,jLab2 
                      00454           jmpClr    RegS,BitS,jLab1 
                      00455           bcf       RegD,BitD 
                      00456           goto      jLab2 
                      00457 jLab1     bsf       RegD,BitD 
                      00458 jLab2 
                      00459           endm 
                      00460 
                      00461 
                      00462 ;;-------------------------------------------------------------
                      00463 ;;  Jump to label if TMR1H (hi byte) < bClk
                      00464 ;;-------------------------------------------------------------
                      00465 
                      00466 jmp1HNotYet  macro bClk, jLabel
                      00467 
                      00468           movfw TMR1H
                      00469           subwf bClk,W
                      00470           andlw 0x80
                      00471           jmpZ jLabel
                      00472           endm
                      00473 
                      00474 ;;-------------------------------------------------------------
                      00475 ;;  Jump to label if TMR1H (low byte) < bClk
                      00476 ;;-------------------------------------------------------------
                      00477 
                      00478 jmp1HDone  macro bClk, jLabel
                      00479 
                      00480           movfw TMR1H
                      00481           subwf bClk,W
                      00482           andlw 0x80
                      00483           jmpNZ jLabel
                      00484           endm
                      00485 
                      00486 
                      00487   
                      00488 ;;**************************************************************
                      00489 
                      00490 
                      00491 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00492 intInc macro iVar
                      00493        incf iVar,F
                      00494        skipNZ
                      00495        incf  iVar+1,F
                      00496        
                      00497        endm 
                      00498 
                      00499 
                      00500 ;*****************************************************************
                      00501 
                      00502 
                      00503 
                      00504 
                      00505 Set1HClock macro bClk,Value
                      00506            movfw TMR1H
                      00507            addlw Value 
                      00508            movwf bClk
                      00509            endm
                      00087 
                      00088         ; embed Configuration Data within .asm File.
2007   3F71           00089         __CONFIG   _WRT_OFF & _CPD_OFF & _CP_OFF &  _WDT_OFF & _LVP_OFF & _BODEN_ON & _PWRTE_ON & _XT_OS
                            C 
2000   0000 0001 0000 00090     __IDLOCS (dVersion<<8)|dRelease; version: vvrr; vv - version, rr - release
       0000 
                      00091 
                      00092   
                      00093 
                      00094 
                      00095 
                      00096 
                      00097 
                      00098  
                      00099      #define menu_stage CanType,7
                      00100      #define data_nibble CanType,6
                      00101      #define config_mode CanType,5
                      00102      #define ertx_flag  CanType,4
                      00103      #define baudrate_flag CanType, 1
                      00104      #define frametype_flag CanType,0
                      00105 
                      00106      #define tp2510_CS_ PORTC,2   ; Chip select
                      00107  
                      00108 
                      00109 
                      00110 ;***** CONSTANT DECLARATION *****
                      00111 
  0020                00112         CONSTANT BASE = 0x20            ; base address of user file registers
                      00113 
                      00114 ;***** CONSTANT DECLARATION *****
                      00115 
                      00116         IFNDEF  LCDLINENUM      ; use default value, if unspecified
                      00117 ;               CONSTANT LCDLINENUM = 0x02      ; by default, 2 lines
                      00118                 CONSTANT LCDLINENUM = 0x04
                      00119         ENDIF
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00120         IFNDEF  LCDTYPE         ; use default value, if unspecified
                      00121         ;       CONSTANT LCDTYPE = 0x00         ; standard HD44780 LCD
                      00122                 CONSTANT LCDTYPE = 0x01 ; EADIP204-4 (w/ KS0073)
                      00123         ENDIF
                      00124         IFNDEF  LCDSPEED        ; use default value, if unspecified
                      00125                 ;CONSTANT LCDSPEED = 0x00       ; clk in [0..9] MHz
                      00126                 CONSTANT LCDSPEED = 0x01        ; clk in [9..20] MHz, default
                      00127         ENDIF
                      00128         IFNDEF  LCDWAIT         ; use default value, if unspecified
                      00129 ;               CONSTANT LCDWAIT = 0x01         ; for Tosc <= 5 MHz
                      00130                 CONSTANT LCDWAIT = 0x04         ; for Tosc = 10 MHz
                      00131         ENDIF
                      00132         IFNDEF  LCDCLRWAIT      ; use default value, if unspecified
                      00133                 CONSTANT LCDCLRWAIT = 0x08      ; wait after LCDCLR until LCD is ready again
                      00134         ENDIF
                      00135 
                      00136 ;***** REGISTER DECLARATION *****
                      00137 
  00000020            00138 OldLATH set     BASE+d'0'       ; wait cycle counter
                      00139 
  00000021            00140 LCDbuf  set     BASE+d'1'       ; LCD data buffer
  00000022            00141 LCDtemp set     BASE+d'2'       ; LCD temporary register
                      00142 
                      00143            ; m_lcdv08
  00000023            00144 LO      equ     BASE+d'3'
  00000024            00145 HI      equ     BASE+d'4'
  00000025            00146 LO_TEMP set     BASE+d'5'
  00000026            00147 HI_TEMP set     BASE+d'6'
                      00148 
                      00149 
  00000027            00150 TEMP1   equ     BASE+d'7'       ; Universal Temporary Register
  00000028            00151 TEMP3   equ     BASE+d'8'
  00000029            00152 TEMP2   equ     BASE+d'9'
  0000002A            00153 TEMP4   equ     BASE+d'10'
  0000002B            00154 TEMP5   equ     BASE+d'11'
                      00155 
  0000002C            00156 LCDFLAGreg      equ     BASE+d'12'
                      00157 
  0000002D            00158 STR_NUM equ BASE+d'13'
  0000002E            00159 INDEX   equ BASE+d'14'
                      00160 
                      00161 
                      00162         #define BCflag   LCDFLAGreg,0x05
                      00163 
                      00164 
                      00165 
                      00166 
                      00167         ;*** LCD module versions for fixed ports (e.g. PortB) ***
  00000085            00168 LCDtris equ     TRISA
  00000005            00169 LCDport equ     PORTA
                      00170 
                      00171  
                      00172     #define     LCD_EN     PORTA,0x04   ; Enable Output / "CLK"
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00173     #define     LCD_RS     PORTA,0x05   ; Register Select
                      00174  
                      00175 
                      00176 
                      00177 
                      00178 ;***** LCD COMMANDS *****
                      00179 
                      00180   ;*** Standard LCD COMMANDS for INIT ***       ( HI-NIBBLE only )
                      00181         ; for 4 bit mode: send only one nibble as high-nibble [DB7:DB4]
  0003                00182         CONSTANT  LCDEM8  = b'0011'     ; entry mode set: 8 bit mode, 2 lines
  0002                00183         CONSTANT  LCDEM4  = b'0010'     ; entry mode set: 4 bit mode, 2 lines
  0008                00184         CONSTANT  LCDDZ   = b'1000'     ; set Display Data Ram Address to zero
                      00185 
                      00186   ;*** Standard LCD COMMANDS ***                ( HI- / LO-NIBBLE )
                      00187         ; USE THESE COMMANDS BELOW AS FOLLOW: "LCDcmd LCDCLR"
  0001                00188         CONSTANT  LCDCLR  = b'00000001' ; 0x01 clear display: resets address counter & cursor
  0002                00189         CONSTANT  LCDCH   = b'00000010' ; 0x02 cursor home
  0006                00190         CONSTANT  LCDCR   = b'00000110' ; 0x06 entry mode set: cursor moves right, display auto-shift of
                            f
  0004                00191         CONSTANT  LCDCL   = b'00000100' ; 0x04 entry mode set: cursor moves left, display auto-shift off
  000C                00192         CONSTANT  LCDCONT = b'00001100' ; 0x0C display control: display on, cursor off, blinking off
  0010                00193         CONSTANT  LCDMCL  = b'00010000' ; 0x10 cursor/disp control: move cursor left
  0014                00194         CONSTANT  LCDMCR  = b'00010100' ; 0x14 cursor/disp control: move cursor right
  0018                00195         CONSTANT  LCDSL   = b'00011000' ; 0x18 cursor/disp control: shift display content left
  001C                00196         CONSTANT  LCDSR   = b'00011100' ; 0x1C cursor/disp control: shift display content right
  0028                00197         CONSTANT  LCD2L   = b'00101000' ; 0x28 function set: 4 bit mode, 2 lines, 5x7 dots
                      00198         IF (LCDLINENUM == 0x2)
                      00199           CONSTANT  LCDL1 = b'10000000' ; DDRAM address: 0x00, selects line 1 (2xXX LCD)
                      00200           CONSTANT  LCDL2 = b'11000000' ; DDRAM address: 0x40, selects line 2 (2xXX LCD)
                      00201           CONSTANT  LCDL3 = b'10010100' ; (DDRAM address: 0x14, fallback)
                      00202           CONSTANT  LCDL4 = b'11010100' ; (DDRAM address: 0x54, fallback)
                      00203         ELSE
  0080                00204           CONSTANT  LCDL1 = b'10000000' ; DDRAM address: 0x00, selects line 1 (4xXX LCD)
  00C0                00205           CONSTANT  LCDL2 = b'11000000' ; DDRAM address: 0x40, selects line 2 (4xXX LCD)
  0094                00206           CONSTANT  LCDL3 = b'10010100' ; DDRAM address: 0x14, selects line 3 (4xXX LCD)
  00D4                00207           CONSTANT  LCDL4 = b'11010100' ; DDRAM address: 0x54, selects line 4 (4xXX LCD)
                      00208         ENDIF
                      00209         ; special configuration for EA DIP204-4
  0009                00210         CONSTANT  LCDEXT  = b'00001001' ; 0x09 extended function set EA DIP204-4
  002C                00211         CONSTANT  LCD2L_A = b'00101100' ; 0x2C enter ext. function set: 4 bit mode, 2 lines, 5x7 dots
  0028                00212         CONSTANT  LCD2L_B = b'00101000' ; 0x28 exit ext. function set: 4 bit mode, 2 lines, 5x7 dots
                      00213 
                      00214 
                      00215 ;***** MACROS *****
                      00216 
                      00217 
                      00218 
                      00219  kkLCD_Text macro LineN, TXMessage
                      00220     LOCAL Message
                      00221     LOCAL START
                      00222     LOCAL EXIT
                      00223     LOCAL I=0
                      00224        goto START
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00225 Message dt TXMessage
                      00226        dt 0
                      00227 START
                      00228     IF LineN==1
                      00229         LCDcmd LCDL1
                      00230     ELSE
                      00231     IF LineN==2
                      00232         LCDcmd LCDL2
                      00233     ELSE
                      00234     IF LineN==3
                      00235         LCDcmd LCDL3
                      00236     ELSE
                      00237     IF LineN==4
                      00238         LCDcmd LCDL4
                      00239     ENDIF
                      00240     ENDIF
                      00241     ENDIF
                      00242     ENDIF
                      00243     WHILE I<20
                      00244          call (Message+I)
                      00245          addlw 0
                      00246          bz EXIT
                      00247          call LCDdata
                      00248          I=I+1 
                      00249     ENDW
                      00250     EXIT
                      00251     endm
                      00252 
                      00253 
                      00254 LCDw    macro                   ; write content of w to LCD
                      00255         call    LCDdata
                      00256         endm
                      00257 
                      00258 LCDcmd  macro   LCDcommand      ; write command to LCD
                      00259         movlw   LCDcommand
                      00260         call    LCDcomd
                      00261         endm
                      00262 
                      00263 
                      00264 
                      00265 LCD_DDAdr macro DDRamAddress
                      00266         Local   value = DDRamAddress | b'10000000'      ; mask command
                      00267         IF (DDRamAddress > 0x67)
                      00268                 ERROR "Wrong DD-RAM-Address specified in LCD_DDAdr"
                      00269         ELSE
                      00270                 movlw   value
                      00271                 call    LCDcomd
                      00272         ENDIF
                      00273         endm
                      00274 
                      00275 LCD_CGAdr macro CGRamAddress
                      00276         Local   value = CGRamAddress | b'01000000'      ; mask command
                      00277         IF (CGRamAddress > b'00111111')
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00278                 ERROR "Wrong CG-RAM-Address specified in LCD_CGAdr"
                      00279         ELSE
                      00280                 movlw   value
                      00281                 call    LCDcomd
                      00282         ENDIF
                      00283         endm
                      00284 
                      00285 clrLCDport macro                ; clear/reset LCD data lines
                      00286         movlw   b'11110000'     ; get mask
                      00287         andwf   LCDport,f       ; clear data lines only
                      00288         endm
                      00289 
                      00290 
                      00291 
                      00292 WAIT    macro   timeconst_1
                      00293         IF (timeconst_1 != 0)
                      00294             movlw       timeconst_1
                      00295             call delay_ms
                      00296         ENDIF
                      00297         endm
                      00298 
                      00299 
                      00300 
                      00301 ;***** MEMORY STRUCTURE *****
                      00302 
                      00303 
                      00304 
                      00305 
                      00306 
                      00307         ORG     0x00                    ; processor reset vector
                      00308 
0000   0000           00309      nop
0001   2???           00310      goto HardStart
                      00311 
                      00312         ORG     0x04                    ; interrupt vector location
                      00313      
                      00314     ; Save context 
0004   00FF           00315      movwf bIntSaveW0
0005   0E03           00316      swapf STATUS,W
                      00317      BANK0
0006   1283               M         bcf     STATUS,5    ; Select page 0 
0007   00B0           00318      movwf bIntSaveSt
0008   0804           00319      movfw FSR
0009   00B1           00320      movwf bIntSaveFSR
000A   080A           00321      movf PCLATH,W
000B   00B2           00322      movwf bIntSavePCLATH
000C   018A           00323      clrf PCLATH
                      00324 
                      00325 
                      00326      ; SPI interrupt
000D   198C           00327      btfsc _SSPIF
000E   2???           00328      goto IntSPI
                      00329 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00330   
                      00331 
                      00332 
                      00333      ; RB0 interrupt by INT CAN
000F   188B           00334      btfsc INTCON,INTF
0010   2???           00335      goto MCP2515_ISR
                      00336 
                      00337  
                      00338      ; Timer0 overflow interrupt flag
                      00339      jmpSet INTCON, TMR0IF, jIntTimer0    
0011   190B               M         btfsc   INTCON,TMR0IF 
0012   2???               M         goto    jIntTimer0 
                      00340 
                      00341    
                      00342      ; Timer1 overflow interrupt flag
                      00343      jmpSet _TMR1IF, jIntTimer1    
0013   180C               M         btfsc   PIR1,TMR1IF 
0014   2???               M         goto    jIntTimer1 
                      00344 
                      00345    
0015                  00346 IntReturn
                      00347      BANK0
0015   1283               M         bcf     STATUS,5    ; Select page 0 
0016   0832           00348      movf bIntSavePCLATH,W
0017   008A           00349      movwf PCLATH
0018   0831           00350      movf bIntSaveFSR,W
0019   0084           00351      movwf FSR
001A   0E30           00352      swapf bIntSaveSt,W
001B   0083           00353      movwf STATUS
001C   0EFF           00354      swapf bIntSaveW0,F
001D   0E7F           00355      swapf bIntSaveW0,W
001E   0009           00356      retfie
                      00357 
                      00358 
                      00359 #include "can_lib.asm"
                      00001 
                      00002 #define RXF0SIDH 0x00
                      00003 #define RXF0SIDL 0x01
                      00004 #define RXF0EID8 0x02
                      00005 #define RXF0EID0 0x03
                      00006 #define RXF1SIDH 0x04
                      00007 #define RXF1SIDL 0x05
                      00008 #define RXF1EID8 0x06
                      00009 #define RXF1EID0 0x07
                      00010 #define RXF2SIDH 0x08
                      00011 #define RXF2SIDL 0x09
                      00012 #define RXF2EID8 0x0A
                      00013 #define RXF2EID0 0x0B
                      00014 #define BFPCTRL  0x0C
                      00015 #define TXRTSCTRL 0x0D
                      00016 #define CANSTAT  0x0E
                      00017 #define CANCTRL  0x0F
                      00018 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00019 #define RXF3SIDH 0x10
                      00020 #define RXF3SIDL 0x11
                      00021 #define RXF3EID8 0x12
                      00022 #define RXF3EID0 0x13
                      00023 #define RXF4SIDH 0x14
                      00024 #define RXF4SIDL 0x15
                      00025 #define RXF4EID8 0x16
                      00026 #define RXF4EID0 0x17
                      00027 #define RXF5SIDH 0x18
                      00028 #define RXF5SIDL 0x19
                      00029 #define RXF5EID8 0x1A
                      00030 #define RXF5EID0 0x1B
                      00031 #define TEC      0x1C
                      00032 #define REC      0x1D
                      00033 #define CANSTAT1 0x1E
                      00034 #define CANCTRL1 0x1F
                      00035 
                      00036 #define RXM0SIDH 0x20
                      00037 #define RXM0SIDL 0x21
                      00038 #define RXM0EID8 0x22
                      00039 #define RXM0EID0 0x23
                      00040 #define RXM1SIDH 0x24
                      00041 #define RXM1SIDL 0x25
                      00042 #define RXM1EID8 0x26
                      00043 #define RXM1EID0 0x27
                      00044 #define CNF3     0x28
                      00045 #define CNF2     0x29
                      00046 #define CNF1     0x2A
                      00047 #define CANINTE  0x2B
                      00048 #define CANINTF  0x2C
                      00049 #define EFLG     0x2D
                      00050 #define CANSTAT2 0x2E
                      00051 #define CANCTRL2 0x2F
                      00052 
                      00053 #define TXB0CTRL 0x30
                      00054 #define TXB0SIDH 0x31
                      00055 #define TXB0SIDL 0x32
                      00056 #define TXB0EID8 0x33
                      00057 #define TXB0EID0 0x34
                      00058 #define TXB0DLC 0x35
                      00059 #define TXB0D0 0x36
                      00060 #define TXB0D1 0x37
                      00061 #define TXB0D2 0x38
                      00062 #define TXB0D3 0x39
                      00063 #define TXB0D4 0x3A
                      00064 #define TXB0D5 0x3B
                      00065 #define TXB0D6 0x3C
                      00066 #define TXB0D7 0x3D
                      00067 #define CANSTAT3 0x3E
                      00068 #define CANCTRL3 0x3F
                      00069 
                      00070 #define TXB1CTRL 0x40
                      00071 #define TXB1SIDH 0x41
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00072 #define TXB1SIDL 0x42
                      00073 #define TXB1EID8 0x43
                      00074 #define TXB1EID0 0x44
                      00075 #define TXB1DLC 0x45
                      00076 #define TXB1D0 0x46
                      00077 #define TXB1D1 0x47
                      00078 #define TXB1D2 0x48
                      00079 #define TXB1D3 0x49
                      00080 #define TXB1D4 0x4A
                      00081 #define TXB1D5 0x4B
                      00082 #define TXB1D6 0x4C
                      00083 #define TXB1D7 0x4D
                      00084 #define CANSTAT4 0x4E
                      00085 #define CANCTRL4 0x4F
                      00086 
                      00087 #define TXB2CTRL 0x50
                      00088 #define TXB2SIDH 0x51
                      00089 #define TXB2SIDL 0x52
                      00090 #define TXB2EID8 0x53
                      00091 #define TXB2EID0 0x54
                      00092 #define TXB2DLC 0x55
                      00093 #define TXB2D0 0x56
                      00094 #define TXB2D1 0x57
                      00095 #define TXB2D2 0x58
                      00096 #define TXB2D3 0x59
                      00097 #define TXB2D4 0x5A
                      00098 #define TXB2D5 0x5B
                      00099 #define TXB2D6 0x5C
                      00100 #define TXB2D7 0x5D
                      00101 #define CANSTAT5 0x5E
                      00102 #define CANCTRL5 0x5F
                      00103 
                      00104 #define RXB0CTRL 0x60
                      00105 #define RXB0SIDH 0x61
                      00106 #define RXB0SIDL 0x62
                      00107 #define RXB0EID8 0x63
                      00108 #define RXB0EID0 0x64
                      00109 #define RXB0DLC 0x65
                      00110 #define RXB0D0 0x66
                      00111 #define RXB0D1 0x67
                      00112 #define RXB0D2 0x68
                      00113 #define RXB0D3 0x69
                      00114 #define RXB0D4 0x6A
                      00115 #define RXB0D5 0x6B
                      00116 #define RXB0D6 0x6C
                      00117 #define RXB0D7 0x6D
                      00118 #define CANSTAT6 0x6E
                      00119 #define CANCTRL6 0x6F
                      00120 
                      00121 #define RXB1CTRL 0x70
                      00122 #define RXB1SIDH 0x71
                      00123 #define RXB1SIDL 0x72
                      00124 #define RXB1EID8 0x73
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00125 #define RXB1EID0 0x74
                      00126 #define RXB1DLC 0x75
                      00127 #define RXB1D0 0x76
                      00128 #define RXB1D1 0x77
                      00129 #define RXB1D2 0x78
                      00130 #define RXB1D3 0x79
                      00131 #define RXB1D4 0x7A
                      00132 #define RXB1D5 0x7B
                      00133 #define RXB1D6 0x7C
                      00134 #define RXB1D7 0x7D
                      00135 #define CANSTAT7 0x7E
                      00136 #define CANCTRL7 0x7F
                      00137 
                      00138 #define RTS0 0x01
                      00139 #define RTS1 0x02
                      00140 #define RTS2 0x04
                      00141 
                      00142 ;********************************************************** 
                      00143 ;********************************************************** 
                      00144 ;  General control flags definitions
                      00145 
                      00146 
                      00147 #define tbWork       bGenFlags1,0   ; working bit
                      00148 #define tbReset      bGenFlags1,1   ; must reset
                      00149 #define tbNewSPI     bGenFlags1,2   ; new SPI data available
                      00150 #define tbRxMsgPend  bGenFlags1,3   ; new CAN message received
                      00151 #define tbTxMsg      bGenFlags1,4   ; xmit next CAN message
                      00152 #define tbRC2NowHigh bGenFlags1,5   ; robot PWM signal high
                      00153 
                      00154 
                      00155 
                      00156 
                      00157 ;********************************************************** 
                      00158 ;********************************************************** 
                      00159  
                      00160  
                      00161 ; MCP2510 Instructions 
                      00162 #define d2510Rd      0x03      ; MCP2510 read instruction 
                      00163 #define d2510Wrt     0x02      ; MCP2510 write instruction 
                      00164 #define d2510Reset   0xC0      ; MCP2510 reset instruction 
                      00165 #define d2510RTS     0x80      ; MCP2510 RTS instruction 
                      00166 #define d2510Status  0xA0      ; MCP2510 Status instruction 
                      00167 #define d2510BitMod  0x05      ; MCP2510 bit modify instruction 
                      00168  
                      00169  
                      00170  
                      00171 #define _SSPEN  SSPCON,SSPEN
                      00172  
                      00173 
                      00174 
                      00175 
                      00176 ;********************************************************** 
                      00177 ;*************** SPECIAL CAN MACROS *********************** 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00178 ;********************************************************** 
                      00179  
                      00180 
                      00181 
                      00182  
                      00183 
                      00184 ; Read 2510 register Reg and return data in W. 
                      00185 SPI_Read macro Reg 
                      00186           movlw     Reg 
                      00187           call      Rd2510Reg 
                      00188           endm 
                      00189  
                      00190 ; Write literal byte to 2510 register Reg. 
                      00191 SPI_WriteL macro Reg,LitData 
                      00192           movlw     LitData 
                      00193           movwf     b2510RegData 
                      00194           movlw     Reg 
                      00195           call      Wrt2510Reg 
                      00196           endm 
                      00197  
                      00198 ; Write Data byte to 2510 register Reg. 
                      00199 SPI_WriteV macro Reg,RegData 
                      00200           movfw     RegData 
                      00201           movwf     b2510RegData 
                      00202           movlw     Reg 
                      00203           call      Wrt2510Reg 
                      00204           endm 
                      00205  
                      00206 ; Write W byte to 2510 register Reg. 
                      00207 SPI_WriteW macro Reg 
                      00208           movwf     b2510RegData 
                      00209           movlw     Reg 
                      00210           call      Wrt2510Reg 
                      00211           endm 
                      00212  
                      00213  
                      00214 ; Write bits determined by Mask & Data to 2510 register Reg. 
                      00215 SPI_BitMod macro Reg,Mask,_Data 
                      00216           movlw     Mask 
                      00217           movwf     b2510RegMask 
                      00218           movlw     _Data 
                      00219           movwf     b2510RegData 
                      00220           movlw     Reg 
                      00221           call      BitMod2510 
                      00222           endm 
                      00223  
                      00224 ; Arm xmit buffers for xmission 
                      00225 SPI_Rts macro _Data 
                      00226           movlw     _Data 
                      00227           call      Rts2510 
                      00228           endm 
                      00229       
                      00230 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00231 
                      00232 
                      00233 
                      00234         
                      00235  
                      00236 ;********************************************************** 
                      00237 ;********************************************************** 
                      00238 ;Support routines for communicating with 2510 chip 
                      00239 ;********************************************************** 
                      00240 ;********************************************************** 
                      00241  
                      00242 ;****************************************************** 
                      00243 ;CheckCANMsg 
                      00244 ; 
                      00245 ; Checks for message in Receive Buf 0.  If no message pending return 
                      00246 ; with Z flag set. 
                      00247 ;          
                      00248 ; If message pending: 
                      00249 ;     Load iRecID_L,iRecID_H with ID. 
                      00250 ;     Load bRecCount with number of bytes of data received. 
                      00251 ;     Load buffer at pRecDataBase with data 
                      00252 ;     Clear 2510 Receive Buffer 1 interrupt flag 
                      00253 ;     Set tbRxMsgPend flag and clear Z flag. 
                      00254 ; 
                      00255 ; NOTE: If message already pending doesn't check for new message. 
                      00256 ; 
                      00257 ;******************************************************/ 
001F                  00258 CheckCANMsg 
                      00259  
001F   1103           00260           bcf       _Z                  ; for return 
                      00261           skipClr   tbRxMsgPend         ; new CAN message received 
0020   19B6               M         btfsc   bGenFlags1,3 
0021   3400           00262           retlw 0                        ; Message already pending 
                      00263  
                      00264      ;; Test for Message pending in Receive Buffer 0   
                      00265            SPI_Read  CANINTF 
0022   302C               M           movlw     0x2C 
0023   2???               M           call      Rd2510Reg 
0024   3901           00266           andlw     0x01       
                      00267  
                      00268           skipNZ 
0025   1903               M         btfsc   _Z 
0026   3400           00269           retlw 0              ; Nothing in Rec Buf 0 
                      00270  
0027   15B6           00271           bsf       tbRxMsgPend         ; new CAN message received 
                      00272  
                      00273      ;; Get ID of message source  
                      00274            SPI_Read  RXB0SIDH 
0028   3061               M           movlw     0x61 
0029   2???               M           call      Rd2510Reg 
002A   00C1           00275           movwf     iRecID_H 
                      00276            SPI_Read  RXB0SIDL         
002B   3062               M           movlw     0x62 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

002C   2???               M           call      Rd2510Reg 
002D   00C0           00277           movwf     iRecID_L    
                      00278      ;; teste from a extended frame
002E   1DC0           00279           btfss iRecID_L,3                              
002F   2???           00280           goto jStdFrame
                      00281      ;; this is a extended frame
                      00282           SPI_Read RXB0EID8
0030   3063               M           movlw     0x63 
0031   2???               M           call      Rd2510Reg 
0032   00C2           00283           movwf iRecEX_H
                      00284           SPI_Read RXB0EID0
0033   3064               M           movlw     0x64 
0034   2???               M           call      Rd2510Reg 
0035   00C3           00285           movwf iRecEX_L
0036                  00286 jStdFrame
0036   30E0           00287           movlw 0xE0
0037   05C0           00288           andwf iRecID_L,F 
                      00289      ;; Get number of bytes of data 
                      00290            SPI_Read  RXB0DLC 
0038   3065               M           movlw     0x65 
0039   2???               M           call      Rd2510Reg 
003A   390F           00291           andlw     0x0F 
003B   00C4           00292           movwf     bRecCount 
                      00293  
                      00294      ;; Get data from buffer. Up to 8 bytes based on  
003C   01B7           00295           clrf      bCnt 
                      00296  
                      00297 jRxChk11  jmpFeqF   bCnt,bRecCount,jRxChk90    ; no data left 
003D   0837               M         movf    bCnt,W 
003E   0244               M         subwf   bRecCount,W 
003F   1903               M         btfsc   _Z 
0040   2???               M         goto    jRxChk90 
                      00298  
                      00299      ;; Calculate correct 2510 receive buffer location 
0041   3066           00300           movlw     RXB0D0 
0042   0737           00301           addwf     bCnt,W 
                      00302  
                      00303      ;; Get data byte 
0043   2???           00304           call      Rd2510Reg 
0044   00CE           00305           movwf     b2510RegData     ; temporary save 
                      00306  
                      00307      ;; Calculate destination buffer location 
0045   3045           00308           movlw     pRecDataBase 
0046   0737           00309           addwf     bCnt,W 
0047   0084           00310           movwf     FSR 
                      00311  
                      00312      ;; Store data in buffer 
0048   084E           00313           movfw     b2510RegData     ; temporary save 
0049   0080           00314           movwf     INDF 
004A   0AB7           00315           incf      bCnt,F 
004B   2???           00316           goto      jRxChk11 
                      00317  
004C                  00318 jRxChk90 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00319           SPI_BitMod CANINTF,0x01,0     ; Clear receive buffer 0 interrupt 
004C   3001               M           movlw     0x01 
004D   00CF               M           movwf     b2510RegMask 
004E   3000               M           movlw     0     
004F   00CE               M           movwf     b2510RegData 
0050   302C               M           movlw     0x2C 
0051   2???               M           call      BitMod2510 
0052   1103           00320           bcf       _Z                  ; signal data pending 
0053   3401           00321           retlw 1 
                      00322  
                      00323  
                      00324 ;********************************************************** 
                      00325 ;SetConfigMode 
                      00326 ; 
                      00327 ;// Function Name: Set_Config_Mode() 
                      00328 ;********************************************************** 
0054                  00329 SetConfigMode 
                      00330 ;  SPI_BitMod(CANCTRL, 0xE0, 0x80);    //Config. mode/ 
                      00331           bL2bV     0xE0,b2510RegMask 
0054   30E0               M         movlw   0xE0 
0055   00CF               M         movwf   b2510RegMask 
                      00332           bL2bV     0x80,b2510RegData 
0056   3080               M         movlw   0x80 
0057   00CE               M         movwf   b2510RegData 
0058   300F           00333           movlw     CANCTRL 
0059   2???           00334           call      BitMod2510 
                      00335  
005A                  00336 jSetConfigM1 
005A   300E           00337           movlw     CANSTAT 
005B   2???           00338           call      Rd2510Reg 
005C   39E0           00339           andlw     0xE0 
005D   3A80           00340           xorlw     0x80 
                      00341           jmpNZ     jSetConfigM1 
005E   1D03               M         btfss   _Z 
005F   2???               M         goto    jSetConfigM1 
                      00342  
0060   0008           00343           return 
                      00344  
                      00345  
                      00346 ;********************************************************** 
                      00347 ;SetNormalMode   0x00
                      00348 ;SetSleepMode    0x20
                      00349 ;SetLoopBackMode 0x40
                      00350 ;SetListenMode   0x60
                      00351 ;SetConfigMode   0x80
                      00352 ; 
                      00353 ;// Function Name: Set_Normal_Mode() 
                      00354 ;********************************************************** 
0061                  00355 SetNormalMode 
                      00356  
                      00357           bL2bV     0xE0,b2510RegMask 
0061   30E0               M         movlw   0xE0 
0062   00CF               M         movwf   b2510RegMask 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00358           bL2bV     0x00,b2510RegData 
0063   3000               M         movlw   0x00 
0064   00CE               M         movwf   b2510RegData 
0065   300F           00359           movlw     CANCTRL 
0066   2???           00360           call      BitMod2510 
                      00361  
0067                  00362 jSetNormalM1 
0067   300E           00363           movlw     CANSTAT 
0068   2???           00364           call      Rd2510Reg 
0069   39E0           00365           andlw     0xE0 
                      00366           jmpNZ     jSetNormalM1 
006A   1D03               M         btfss   _Z 
006B   2???               M         goto    jSetNormalM1 
                      00367  
006C   0008           00368           return 
                      00369 
                      00370 
                      00371 
                      00372 
                      00373 ;********************************************************** 
                      00374 ;SetLoopBackMode  
                      00375 ; 
                      00376 ;// Function Name: Set_LoopBack_Mode() 
                      00377 ;********************************************************** 
006D                  00378 SetLoopBackMode 
                      00379           bL2bV     0x40,b2510RegData 
006D   3040               M         movlw   0x40 
006E   00CE               M         movwf   b2510RegData 
                      00380           bL2bV     0xE0,b2510RegMask 
006F   30E0               M         movlw   0xE0 
0070   00CF               M         movwf   b2510RegMask 
0071   300F           00381           movlw     CANCTRL 
0072   2???           00382           call      BitMod2510 
                      00383  
0073                  00384 jSetLoopBackM1 
0073   300E           00385           movlw     CANSTAT 
0074   2???           00386           call      Rd2510Reg 
0075   39E0           00387           andlw     0xE0 
0076   3A40           00388           xorlw     0x40  
                      00389           jmpNZ     jSetLoopBackM1 
0077   1D03               M         btfss   _Z 
0078   2???               M         goto    jSetLoopBackM1 
                      00390  
0079   0008           00391           return 
                      00392 
                      00393 ;**************************************************
                      00394 
007A                  00395 Set2510Mode 
007A   00CE           00396           movwf     b2510RegData
                      00397           bL2bV     0xE0,b2510RegMask 
007B   30E0               M         movlw   0xE0 
007C   00CF               M         movwf   b2510RegMask 
007D   300F           00398           movlw     CANCTRL 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

007E   2???           00399           call      BitMod2510 
                      00400  
007F                  00401 jSet2510M1 
007F   300E           00402           movlw     CANSTAT 
0080   2???           00403           call      Rd2510Reg 
0081   39E0           00404           andlw     0xE0 
0082   3A4E           00405           xorlw     b2510RegData  
                      00406           jmpNZ     jSet2510M1 
0083   1D03               M         btfss   _Z 
0084   2???               M         goto    jSet2510M1 
                      00407  
0085   0008           00408           return 
                      00409 
                      00410  
                      00411 
                      00412 ;********************************************************** 
                      00413 ;SetListenMode  
                      00414 ; 
                      00415 ;// Function Name: Set_Listen_Mode() 
                      00416 ;********************************************************** 
0086                  00417 SetListenMode 
                      00418  
                      00419           bL2bV     0xE0,b2510RegMask 
0086   30E0               M         movlw   0xE0 
0087   00CF               M         movwf   b2510RegMask 
                      00420           bL2bV     0x60,b2510RegData 
0088   3060               M         movlw   0x60 
0089   00CE               M         movwf   b2510RegData 
008A   300F           00421           movlw     CANCTRL 
008B   2???           00422           call      BitMod2510 
                      00423  
008C                  00424 jSetListenM1 
008C   300E           00425           movlw     CANSTAT 
008D   2???           00426           call      Rd2510Reg 
008E   39E0           00427           andlw     0xE0 
008F   3A60           00428           xorlw     0x60 
                      00429           jmpNZ     jSetListenM1 
0090   1D03               M         btfss   _Z 
0091   2???               M         goto    jSetListenM1 
                      00430  
0092   0008           00431           return 
                      00432 
                      00433 
                      00434 
                      00435 ;********************************************************** 
                      00436 ;WaitANDeqZ 
                      00437 ;         Wait for byte from address in W to AND with mask in 
                      00438 ;         b2510RegMask to be zero. Uses b2510RegAdr to hold address. 
                      00439 ;          
                      00440 ;********************************************************** 
0093                  00441 WaitANDeqZ 
0093   00CD           00442           movwf     b2510RegAdr         ; save 
                      00443  
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0094                  00444 jWaitANDeqZ 
0094   084D           00445           movfw     b2510RegAdr         ; save 
0095   2???           00446           call      Rd2510Reg 
0096   054F           00447           andwf     b2510RegMask,W 
                      00448           jmpNZ     jWaitANDeqZ 
0097   1D03               M         btfss   _Z 
0098   2???               M         goto    jWaitANDeqZ 
0099   0008           00449           return 
                      00450  
                      00451  
                      00452 ;********************************************************** 
                      00453 ;********************************************************** 
                      00454  
                      00455  
                      00456 ;********************************************************** 
                      00457 ;**************** BASIC COMMUNICATION ********************* 
                      00458 ;********************************************************** 
                      00459  
                      00460  
                      00461 ;********************************************************** 
                      00462 ;Get2510Status 
                      00463 ;         Get Status byte from 2510. 
                      00464 ;// Function Name: SPI_ReadStatus() 
                      00465 ;********************************************************** 
009A                  00466 Get2510Status 
009A   2???           00467           call      InitSPIBuf 
009B   30A0           00468           movlw     d2510Status          ; MCP2510 Status instruction 
009C   2???           00469           call      LoadSPIByte 
009D   3001           00470           movlw     1                   ; expect 1 byte answer 
009E   2???           00471           call      LoadSPIZeros 
009F   2???           00472           call      ExchangeSPI 
00A0   2???           00473           call      WaitSPIExchange 
00A1   0008           00474           return 
                      00475  
                      00476 ;********************************************************** 
                      00477 ;Rd2510Reg 
                      00478 ;         Read 2510 register at address in W. Return results 
                      00479 ;         in W. Uses b2510RegAdr to hold address. 
                      00480 ;// Function Name: SPI_Read(uint address) 
                      00481 ;********************************************************** 
00A2                  00482 Rd2510Reg 
00A2   00CD           00483           movwf     b2510RegAdr         ; save 
00A3   2???           00484           call      InitSPIBuf 
00A4   3003           00485           movlw     d2510Rd              ; MCP2510 read instruction 
00A5   2???           00486           call      LoadSPIByte 
00A6   084D           00487           movfw     b2510RegAdr         ; get address 
00A7   2???           00488           call      LoadSPIByte 
00A8   3001           00489           movlw     1                   ; expect 1 byte answer 
00A9   2???           00490           call      LoadSPIZeros 
00AA   2???           00491           call      ExchangeSPI 
00AB   2???           00492           call      WaitSPIExchange 
00AC   0854           00493           movfw     pSPIBufBase+2 
00AD   0008           00494           return 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00495  
                      00496 ;********************************************************** 
                      00497 ;Wrt2510Reg 
                      00498 ;         Write byte in b2510RegData to 2510 register at location in W.  
                      00499 ;         Uses b2510RegAdr to hold address. 
                      00500 ;// Function Name: SPI_Write(uint address) 
                      00501 ;********************************************************** 
00AE                  00502 Wrt2510Reg 
00AE   00CD           00503           movwf     b2510RegAdr         ; save 
00AF   2???           00504           call      InitSPIBuf 
00B0   3002           00505           movlw     d2510Wrt             ; MCP2510 write instruction 
00B1   2???           00506           call      LoadSPIByte 
00B2   084D           00507           movfw     b2510RegAdr         ; get address 
00B3   2???           00508           call      LoadSPIByte 
00B4   084E           00509           movfw     b2510RegData        ; get data 
00B5   2???           00510           call      LoadSPIByte 
00B6   2???           00511           call      ExchangeSPI 
00B7   2???           00512           call      WaitSPIExchange 
00B8   0008           00513           return 
                      00514  
                      00515  
                      00516 ;********************************************************** 
                      00517 ;BitMod2510 
                      00518 ;// Function Name: SPI_BitMod() 
                      00519 ;         Write data in b2510RegData using mask in b2510RegMask to  
                      00520 ;         address in W. Uses b2510RegAdr to hold address. 
                      00521 ;********************************************************** 
00B9                  00522 BitMod2510 
00B9   00CD           00523           movwf     b2510RegAdr         ; save 
00BA   2???           00524           call      InitSPIBuf 
                      00525  
00BB   3005           00526           movlw     d2510BitMod         ; MCP2510 bit modify instruction 
00BC   2???           00527           call      LoadSPIByte 
                      00528  
00BD   084D           00529           movfw     b2510RegAdr         ; address 
00BE   2???           00530           call      LoadSPIByte 
                      00531  
00BF   084F           00532           movfw     b2510RegMask        ; mask 
00C0   2???           00533           call      LoadSPIByte 
                      00534  
00C1   084E           00535           movfw     b2510RegData        ; data 
00C2   2???           00536           call      LoadSPIByte 
                      00537  
00C3   2???           00538           call      ExchangeSPI 
00C4   2???           00539           call      WaitSPIExchange 
00C5   0008           00540           return 
                      00541  
                      00542  
                      00543 ;********************************************************** 
                      00544 ;Rts2510 
                      00545 ;         Request to send to MCP2510. 
                      00546 ;         Send the request to send instruction to the CANbus Controller ORed 
                      00547 ;         with value in W.  Uses b2510RegData. 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00548 ;// Function Name: SPI_Reset() 
                      00549 ;********************************************************** 
00C6                  00550 Rts2510 
00C6   00CE           00551           movwf     b2510RegData 
00C7   2???           00552           call      InitSPIBuf 
                      00553  
00C8   3080           00554           movlw     d2510RTS            ; MCP2510 RTS instruction 
00C9   044E           00555           iorwf     b2510RegData,W      ; get data and OR it with RTS 
00CA   2???           00556           call      LoadSPIByte 
                      00557  
00CB   2???           00558           call      ExchangeSPI 
00CC   2???           00559           call      WaitSPIExchange 
00CD   0008           00560           return 
                      00561  
                      00562  
                      00563 ;********************************************************** 
                      00564 ;Reset2510 
                      00565 ;         Reset MCP2510. 
                      00566 ;// Function Name: SPI_Reset() 
                      00567 ;********************************************************** 
00CE                  00568 Reset2510 
00CE   2???           00569           call      InitSPIBuf 
00CF   30C0           00570           movlw     d2510Reset           ; MCP2510 reset instruction 
00D0   2???           00571           call      LoadSPIByte 
00D1   2???           00572           call      ExchangeSPI 
00D2   2???           00573           call      WaitSPIExchange 
00D3   0008           00574           return 
                      00575  
                      00576  
                      00577  
                      00578 ;********************************************************** 
                      00579 ;***************** LOCAL - DON'T CALL DIRECTLY ************ 
                      00580 ;********************************************************** 
                      00581  
                      00582 ;********************************************************** 
                      00583 ;InitSPIPort 
                      00584 ;         Intialize SPI port 
                      00585 ;********************************************************** 
00D4                  00586 InitSPIPort
                      00587         BANK0     
00D4   1283               M         bcf     STATUS,5    ; Select page 0 
00D5   3011           00588           movlw     0x11           ; SPI Master, Idle high, Fosc/16 
00D6   0094           00589           movwf     SSPCON               
                      00590           BANK1 
00D7   1683               M         bsf     STATUS,5    ; Select page 1 
00D8   0194           00591           clrf      SSPSTAT        ; data sample at the middle, idle to active clock state
00D9   158C           00592           bsf       PIE1, SSPIE      ; SSP int enable (BANK 1) 
                      00593           BANK0 
00DA   1283               M         bcf     STATUS,5    ; Select page 0 
00DB   1694           00594           bsf       SSPCON, SSPEN         ; enable SPI 
00DC   0008           00595           return 
                      00596   
                      00597 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00598 ;*********************************************
                      00599 
                      00600 
                      00601 
00DD                  00602 Init2510aa
00DD   2???           00603     call Reset2510 
                      00604     
                      00605     ; Set CLKOUT prescaler to div by 4
                      00606 ;    bL2bV 0x03, b2510RegMask
                      00607 ;    bL2bV 0x02, b2510RegData
                      00608     bL2bV 0x07, b2510RegMask ; disable clkout
00DE   3007               M         movlw   0x07 
00DF   00CF               M         movwf   b2510RegMask 
                      00609     bL2bV 0x02, b2510RegData
00E0   3002               M         movlw   0x02 
00E1   00CE               M         movwf   b2510RegData 
00E2   300F           00610     movlw CANCTRL
00E3   2???           00611     call BitMod2510
                      00612 
                      00613     ; Set physical layer configuration
                      00614     ;
                      00615     ; Fosc       = 16Mhz
                      00616     ; BRP        = 2  ( divide by 8)
                      00617     ; Sync Seg   = 1TQ
                      00618     ; Prop Seg   = 2TQ
                      00619     ; Phase Seg1 = 10TQ
                      00620     ; Phase Seg2 = 3TQ
                      00621     ;
                      00622     ; TQ = 2 * (1/Fosc) * (BRP+1)
                      00623     ;
                      00624 
                      00625     SPI_WriteL CNF1, 0x02   ; 0x07 set BRP
00E4   3002               M           movlw     0x02    
00E5   00CE               M           movwf     b2510RegData 
00E6   302A               M           movlw     0x2A 
00E7   2???               M           call      Wrt2510Reg 
                      00626 
                      00627     ; BTLMODE_CNF3   0x80
                      00628     ; SMPL_1X        0x00
                      00629     ; PHSEG1_3QT     0x10
                      00630     ; PHSEG_1QT      0x00
                      00631     SPI_WriteL CNF2, 0x90   ;
00E8   3090               M           movlw     0x90    
00E9   00CE               M           movwf     b2510RegData 
00EA   3029               M           movlw     0x29 
00EB   2???               M           call      Wrt2510Reg 
                      00632 
                      00633     ; PHSEG2_3QT     0x03 
                      00634     SPI_WriteL CNF3, 0x03   ;
00EC   3003               M           movlw     0x03    
00ED   00CE               M           movwf     b2510RegData 
00EE   3028               M           movlw     0x28 
00EF   2???               M           call      Wrt2510Reg 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00635 
                      00636 
                      00637 
                      00638     ; Configure receive buffer 0 Mask and filters
                      00639     ; Receive buffer o will not be used
                      00640      SPI_WriteL RXM0SIDH, 0x00
00F0   3000               M           movlw     0x00    
00F1   00CE               M           movwf     b2510RegData 
00F2   3020               M           movlw     0x20 
00F3   2???               M           call      Wrt2510Reg 
                      00641      SPI_WriteL RXM0SIDL, 0x00
00F4   3000               M           movlw     0x00    
00F5   00CE               M           movwf     b2510RegData 
00F6   3021               M           movlw     0x21 
00F7   2???               M           call      Wrt2510Reg 
                      00642 
                      00643      SPI_WriteL RXF0SIDH, 0xdf
00F8   30DF               M           movlw     0xdf    
00F9   00CE               M           movwf     b2510RegData 
00FA   3000               M           movlw     0x00 
00FB   2???               M           call      Wrt2510Reg 
                      00644      SPI_WriteL RXF0SIDL, 0x07
00FC   3007               M           movlw     0x07    
00FD   00CE               M           movwf     b2510RegData 
00FE   3001               M           movlw     0x01 
00FF   2???               M           call      Wrt2510Reg 
                      00645 
                      00646  ;   SPI_WriteL RXF1SIDH, 0xFF
                      00647  ;   SPI_WriteL RXF1SIDL, 0xFF
                      00648 
                      00649     ; Configure receive Buffer 1 Mask and Filyers
                      00650  ;   SPI_WriteL RXM1SIDH, 0xFF
                      00651  ;   SPI_WriteL RXM1SIDL, 0xE0
                      00652 
                      00653     ; Initialize Filter 2 to match x0 bBasedRecID from DIP switch
                      00654  ;   SPI_WriteL RXF2SIDH, bBaseRecID
                      00655  ;   SPI_WriteL RXF2SIDL, 0x00
                      00656 
                      00657      ; Initialize Filter 3 to match x1 bBasedRecID from DIP switch
                      00658  ;   incf    bBaseRecID,F
                      00659  ;   SPI_WriteL RXF3SIDH, bBaseRecID
                      00660  ;   SPI_WriteL RXF3SIDL, 0x00
                      00661 
                      00662      ; Initialize Filter 4 to match x1 bBasedRecID from DIP switch
                      00663  ;   incf    bBaseRecID,F
                      00664  ;   SPI_WriteL RXF4SIDH, bBaseRecID
                      00665  ;   SPI_WriteL RXF4SIDL, 0x00
                      00666 
                      00667      ; Initialize Filter 5 to match x1 bBasedRecID from DIP switch
                      00668 ;    incf    bBaseRecID,F
                      00669 ;    SPI_WriteL RXF5SIDH, bBaseRecID
                      00670 ;    SPI_WriteL RXF5SIDL, 0x00
                      00671 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00672  ;    movlw b'11110000'
                      00673  ;    andwf bBaseRecID,F
                      00674   
                      00675     ; clear MCP2515 interrupts
                      00676     ;  1-------    Error on TX/RX message  
                      00677     ;  -0------    CAN bus activity
                      00678     ;  --0-----    Interrupt on EFLAG reg
                      00679     ;  ---0----    TXB2 empty
                      00680     ;  ------10    Messsage received on RXB1
                      00681     ;  -------1    Messsage received on RXB0
                      00682 
                      00683     bL2bV   0x83, b2510RegData
0100   3083               M         movlw   0x83 
0101   00CE               M         movwf   b2510RegData 
0102   302B           00684     movlw CANINTE
0103   2???           00685     call Wrt2510Reg
                      00686 
                      00687   ;    call SetNormalMode
0104   3040           00688      movlw 0x40
0105   2???           00689      call Set2510Mode
                      00690   ;   call SetListenMode
                      00691 
0106   0008           00692     return
                      00693 
                      00694 
                      00695 
                      00696 
                      00697 ;****************************************************
                      00698 ;********************************************************** 
                      00699 ;InitSPIBuf 
                      00700 ;         Initializes SPI buffer for transaction.  Sets up 
                      00701 ;         FSR as buffer pointer. 
                      00702 ;********************************************************** 
0107                  00703 InitSPIBuf 
0107   01D0           00704           clrf      bSPICnt 
0108   3052           00705           movlw     pSPIBufBase 
0109   00D1           00706           movwf     pSPIBuf 
010A   0084           00707           movwf     FSR 
010B   0008           00708           return 
                      00709  
                      00710 
                      00711 
                      00712 
010C                  00713 ProccessSPI
                      00714      skipSet bSPICnt,2
010C   1D50               M         btfss   bSPICnt,2 
                      00715      ; buffer not full yet
010D   0008           00716      return
                      00717   
                      00718      ; disable SPI interrupt
                      00719      BANK1
010E   1683               M         bsf     STATUS,5    ; Select page 1 
010F   118C           00720      bcf   PIE1, SSPIE
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00721      BANK0
0110   1283               M         bcf     STATUS,5    ; Select page 0 
                      00722 
                      00723      ; enable SPI  
                      00724      BANK1
0111   1683               M         bsf     STATUS,5    ; Select page 1 
0112   158C           00725       bsf  PIE1, SSPIE      
                      00726 
                      00727      BANK0
0113   1283               M         bcf     STATUS,5    ; Select page 0 
                      00728     
0114   0008           00729      return
                      00730 
                      00731 ;*****************************************************
                      00732 
                      00733 ;********************************************************** 
                      00734 ;LoadSPIByte 
                      00735 ;         Load byte in W to SPI buffer.  Assumes FSR is pointer. 
                      00736 ;********************************************************** 
0115                  00737 LoadSPIByte 
0115   0080           00738           movwf     INDF 
0116   0A84           00739           incf      FSR,F 
0117   0008           00740           return 
                      00741  
                      00742 ;********************************************************** 
                      00743 ;LoadSPIZeros 
                      00744 ;         Load number of zeros in W to SPI buffer.   
                      00745 ;         Assumes FSR is pointer. 
                      00746 ;********************************************************** 
0118                  00747 LoadSPIZeros 
0118   39FF           00748           andlw     0xFF 
                      00749           skipNZ 
0119   1903               M         btfsc   _Z 
011A   0008           00750           return                        ; finished 
011B   0180           00751           clrf      INDF 
011C   0A84           00752           incf      FSR,F 
011D   3EFF           00753           addlw     0xFF                ; Subtract 1 from W 
                      00754           jmpNZ     LoadSPIZeros 
011E   1D03               M         btfss   _Z 
011F   2???               M         goto    LoadSPIZeros 
0120   0008           00755           return 
                      00756  
                      00757 ;********************************************************** 
                      00758 ;ExchangeSPI 
                      00759 ;         Initiate SPI transaction.   
                      00760 ;********************************************************** 
0121                  00761 ExchangeSPI 
                      00762      ;; Get number of bytes to exchange 
                      00763           bV2bV     FSR,bSPICnt 
0121   0804               M         movf    FSR,W     
0122   00D0               M         movwf   bSPICnt 
0123   3052           00764           movlw     pSPIBufBase 
0124   02D0           00765           subwf     bSPICnt,F 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00766  
                      00767           skipNZ 
0125   1903               M         btfsc   _Z 
0126   0008           00768           return                        ; nothing to exchange 
                      00769  
0127   3052           00770           movlw     pSPIBufBase 
0128   00D1           00771           movwf     pSPIBuf 
                      00772  
                      00773      ;; Load 1st byte to begin exchange 
0129   1107           00774           bcf       tp2510_CS_           ; CS_ for 2510 chip 
012A   0852           00775           movfw     pSPIBufBase         ; get 1st byte in buffer 
012B   0093           00776           movwf     SSPBUF              ; send it 
012C   0008           00777           return 
                      00778  
                      00779  
                      00780 ;********************************************************** 
                      00781 ;WaitSPIExchange 
                      00782 ;         Wait for SPI transaction to be completed. 
                      00783 ;********************************************************** 
012D                  00784 WaitSPIExchange 
                      00785   ;      bsf INTCON,GIE
                      00786   ;      nop
                      00787   ;      nop
                      00788   ;      bcf INTCON,GIE
012D   08D0           00789         movf    bSPICnt,F 
012E   1D03           00790         btfss   _Z 
012F   2???           00791         goto    WaitSPIExchange 
0130   0008           00792         return 
                      00793 
                      00794 
                      00795 
                      00796        
                      00360 
                      00361 
                      00362 
0131                  00363 MCP2515_ISR
0131   0806           00364      movfw PORTB
0132   108B           00365      bcf INTCON,INTF
0133   3045           00366      movlw 'E'
0134   2???           00367      call LCDdata
                      00368     
0135   2???           00369      goto IntReturn
                      00370 
                      00371 ;*********************************************
                      00372 ;IntSPI
0136                  00373 IntSPI
0136   118C           00374     bcf _SSPIF
                      00375 
                      00376     ; transfer received byte to the next location in the buffer
                      00377 
0137   0851           00378     movf pSPIBuf, W
0138   0084           00379     movwf FSR
0139   0AD1           00380     incf pSPIBuf, F
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00381 
013A   0813           00382     movfw SSPBUF
013B   0080           00383     movwf INDF
                      00384   
013C   0BD0           00385     decfsz bSPICnt,F
013D   2???           00386     goto jIntSPI2
                      00387 
                      00388     ; last transaction complete
013E   1507           00389     bsf tp2510_CS_
013F   2???           00390     goto IntReturn
                      00391 
0140                  00392 jIntSPI2
0140   0A84           00393     incf   FSR, F
0141   0800           00394     movfw INDF
0142   0093           00395     movwf SSPBUF
0143   2???           00396     goto IntReturn
                      00397 
                      00398 
                      00399 
                      00400 ;***********************************************
                      00401 
0144                  00402 jIntTimer0
0144   110B           00403      bcf INTCON, TMR0IF
                      00404 
0145   2???           00405      goto IntReturn
                      00406 
                      00407 
                      00408 ;********************************************
                      00409 
                      00410 
                      00411 
0146                  00412 jIntTimer1
0146   100C           00413      bcf _TMR1IF
Message[305]: Using default destination of 1 (file).
0147   0AB8           00414      incf iTimer1
0148   2???           00415      goto IntReturn
                      00416      
                      00417  
                      00418   
                      00419 
                      00420 
                      00421 ;**************************************************
                      00422 
                      00423 
                      00424 ;jKey_ISR
                      00425 ;     bcf INTCON,RBIF
                      00426 ;     clrf cdata
                      00427 ;     clrf PORTB
                      00428 ;     movlw 0x10
                      00429 ;     movwf cbit
                      00430 ;keyLoop
                      00431 ;     movfw cbit
                      00432 ;     movwf PORTB
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00433 ;     movfw PORTB
                      00434 ;     andlw 0x20  
                      00435 ;     btfss _Z
                      00436 ;     movfw cbit
                      00437 ;     iorwf cdata,F 
                      00438 ;     bcf _C
                      00439 ;     rrf cbit,F
                      00440 ;     btfss _C
                      00441 ;     goto keyLoop
                      00442   ;   goto IntReturn
                      00443 ;     return
                      00444 
                      00445 
                      00446 ;******************************************************
                      00447 ;*****************************************************
                      00448 ;*****************************************************
                      00449 
                      00450 
                      00451 
                      00452 
                      00453 
                      00454 
                      00455 ;************** MAIN **************
                      00456 
                      00457 
                      00458 
0149                  00459 HardStart
0149   2???           00460      call Init
014A   1507           00461      bsf tp2510_CS_  
                      00462                      ;       bit 0 = 0 ->CAN 11 bits
014B   3002           00463      movlw 2         ;       bit 0 = 1 ->CAN 29 bits
014C   00E2           00464      movwf CanType   ;       bit 1 = 0 ->250Khz
                      00465                      ;       bit 1 = 1 ->500Khz    
014D   2???           00466      call LCDinit
                      00467 
014E   30C2           00468      movlw LCDL2+2
014F   2???           00469      call LCDcomd
0150   3009           00470      movlw 9
0151   2???           00471      call LCDText 
                      00472 ;    LCD_Text 1," Electro-Solucoes"  
                      00473 
0152   3008           00474      movlw 8
0153   00E4           00475      movwf SaveReg
0154   30FF           00476 p1   movlw 0xff
0155   2???           00477      call delay_ms
Message[305]: Using default destination of 1 (file).
0156   0BE4           00478      decfsz SaveReg   
0157   2???           00479      goto p1
                      00480      
0158   3001           00481      movlw LCDCLR
0159   2???           00482      call LCDcomd
                      00483 
                      00484 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

015A   3085           00485      movlw LCDL1+5
015B   2???           00486      call LCDcomd
015C   3000           00487      movlw 0
015D   2???           00488      call LCDText 
                      00489 ;    LCD_Text 1,"      O B D 2"
                      00490 
015E   2???           00491      call InitSPIPort
                      00492   
                      00493           ; Wait 28ms for MCP2515 to initialize
015F   301C           00494      movlw 28
0160   2???           00495      call delay_ms
                      00496 
0161   3094           00497     movlw LCDL3 
0162   2???           00498     call LCDcomd
                      00499    
                      00500 
                      00501   ;   call Init2510
                      00502 
0163   2???           00503       call Init1  
                      00504   
                      00505  
                      00506 ;     call jSendFrame
                      00507   
                      00508  ;    SPI_Read TXB0CTRL
                      00509  ;    andlw 0x40
                      00510  ;    btfss _Z
                      00511  ;    goto jErr
                      00512  ;    kkLCD_Text LCDL4,"Success"
                      00513  ;    goto jMainLoop
                      00514 ;jErr
                      00515 ;     kkLCD_Text LCDL4,"Error"
                      00516    
0164                  00517 jMainLoop
0164   1003           00518       bcf _C
0165   1103           00519       bcf _Z
0166   2???           00520       call ParseKey
0167   2???           00521       call CheckCANMsg
0168   3E00           00522       addlw 0
0169   1903           00523       btfsc _Z
016A   2???           00524       goto jMainLoop
                      00525       ; printf msg id
                      00526     
016B   3094           00527      movlw LCDL3
016C   2???           00528      call LCDcomd
016D   3003           00529      movlw 3
016E   2???           00530      call LCDText 
                      00531 ;      LCD_Text 3, "Msg ID "
                      00532       
016F   1C62           00533       btfss CanType,0
0170   2???           00534       goto jRecStd
                      00535 
0171   0843           00536       movfw iRecEX_L
0172   2???           00537       call LCD_Hex
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0173   0842           00538       movfw iRecEX_H
0174   2???           00539       call LCD_Hex
0175                  00540 jRecStd
0175   0841           00541       movfw iRecID_H
0176   2???           00542       call LCD_Hex
0177   0840           00543       movfw iRecID_L
0178   2???           00544       call LCD_Hex
                      00545       
0179   2???           00546       goto jMainLoop
                      00547 
                      00548 ;*************************************
                      00549 
                      00550  
                      00551 
017A                  00552  ParseKey
017A   0C06           00553      rrf PORTB,W
017B   3A7F           00554      xorlw 0x7f
017C   1903           00555      btfsc _Z
017D   0008           00556      return 
017E   00E4           00557      movwf SaveReg
017F                  00558 waitK
                      00559 
017F   0C06           00560      rrf PORTB,W
0180   3AFF           00561      xorlw 0xff
0181   1D03           00562      btfss _Z
Message[305]: Using default destination of 1 (file).
0182   04E4           00563      iorwf SaveReg
0183   1D03           00564      btfss _Z
0184   2???           00565      goto waitK      ; wait for key depress
0185   0864           00566      movfw SaveReg
0186   3C14           00567      sublw 0x14
0187   1903           00568      btfsc _Z
0188   2???           00569      goto CfgFunc 
0189   1EE2           00570      btfss config_mode
018A   0008           00571      return
018B   1864           00572       btfsc SaveReg,0
018C   2???           00573       goto Key_Left
018D   18E4           00574       btfsc SaveReg,1
018E   2???           00575       goto Key_Up
018F   1964           00576       btfsc SaveReg,2
0190   2???           00577       goto Key_Right
0191   19E4           00578       btfsc SaveReg,3
0192   2???           00579       goto Key_Down
0193   1A64           00580       btfsc SaveReg,4
0194   2???           00581       goto Key_Enter
0195   0008           00582      return
                      00583      
                      00584   
                      00585  
0196                  00586 ParseKey1
0196   0C06           00587      rrf PORTB,W
0197   3A7F           00588      xorlw 0x7f
0198   1903           00589      btfsc _Z
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0199   0008           00590      return 
019A   00E4           00591      movwf SaveReg
019B                  00592 waitK1
019B   0C06           00593      rrf PORTB,W
019C   3AFF           00594      xorlw 0xff
019D   1D03           00595      btfss _Z
019E   2???           00596      goto waitK      ; wait for key depress
                      00597  
019F   1864           00598       btfsc SaveReg,0
01A0   2???           00599       goto Key_Left
01A1   18E4           00600       btfsc SaveReg,1
01A2   2???           00601       goto Key_Up
01A3   1964           00602       btfsc SaveReg,2
01A4   2???           00603       goto Key_Right
01A5   19E4           00604       btfsc SaveReg,3
01A6   2???           00605       goto Key_Down
01A7   1A64           00606       btfsc SaveReg,4
01A8   2???           00607       goto Key_Enter
01A9   0008           00608      return
                      00609      
                      00610    
                      00611      
                      00612 
                      00613 
                      00614 ;******************************************************
                      00615 
                      00616 ;ParseError
                      00617 ;     SPI_Read CANINTF
                      00618 ;     andlw 0xA0
                      00619 ;     btfsc _Z
                      00620 ;     return
                      00621 
                      00622 ;      movlw LCDL4
                      00623 ;      call LCDcomd
                      00624 ;      movlw 3
                      00625 ;      call OutText  ; CAN Error
                      00626 ;      SPI_Read EFLG
                      00627 ;      call LCDval08 
                      00628 
                      00629     ; Clear interrupt flag
                      00630 ;     bL2bV 0xA0, b2510RegMask 
                      00631 ;     bL2bV 0x00, b2510RegData
                      00632 ;     movlw CANINTF
                      00633 ;     call BitMod2510 
                      00634 
                      00635 ;     bL2bV 0xC0, b2510RegMask 
                      00636 ;     bL2bV 0x00, b2510RegData
                      00637 ;     movlw EFLG
                      00638 ;     call BitMod2510 
                      00639  ;    return
                      00640 ;****************************************
                      00641 
                      00642 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00643 ;TxCANMessage
                      00644 ;     ; Wait for pending message to be sent
                      00645 ;     bL2bV   0x08, b2510RegMask
                      00646 ;     movlw TXB0CTRL
                      00647 ;     call WaitANDeqZ
                      00648 
                      00649      ; Send CAN Standard frame
                      00650 
                      00651 ;     SPI_WriteL TXB0SIDH, 0x07  ; message ID
                      00652 ;     SPI_WriteL TXB0SIDL, 0xdf     ; Send message - lower bits 0
                      00653 ;     SPI_WriteL TXB0DLC, 0x08      ; n data bytes
                      00654      
                      00655     ; Send least significante byte first
                      00656 ;     SPI_WriteL TXB0D0, 0x01  ; SID $01
                      00657 ;     SPI_WriteL TXB0D1, 0x00  ; PID $00
                      00658 ;     SPI_Rts RTS0                  ; Transmit buffer 0
                      00659 
                      00660 ;      bsf T1CON,TMR1ON     ; Start TMR1
                      00661 ;     return
                      00662 
                      00663 ;*******************************************************
                      00664 
                      00665 
                      00666 
01AA                  00667 ParseCAN
                      00668       SPI_Read CANINTF
01AA   302C               M           movlw     0x2C 
01AB   2???               M           call      Rd2510Reg 
                      00669    
                      00670  
                      00671    
01AC   3002           00672      movlw 2
01AD   2???           00673      call LCDcomd
01AE   3003           00674      movlw 3
01AF   2???           00675      call LCDText 
                      00676 ;      LCD_Text 2, "CAN OK"
                      00677     
01B0   0841           00678       movfw iRecID_H
01B1   00A4           00679       movwf HI
01B2   0840           00680       movfw iRecID_L 
01B3   00A3           00681       movwf LO
01B4   2???           00682       call LCDval16
                      00683   
                      00684     
01B5   11B6           00685        bcf tbRxMsgPend 
                      00686    
                      00687      ; Clear interrupt flag
                      00688      bL2bV 0x03, b2510RegMask 
01B6   3003               M         movlw   0x03 
01B7   00CF               M         movwf   b2510RegMask 
                      00689      bL2bV 0x00, b2510RegData
01B8   3000               M         movlw   0x00 
01B9   00CE               M         movwf   b2510RegData 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01BA   302C           00690      movlw CANINTF
01BB   2???           00691      call BitMod2510 
01BC   0008           00692      return
                      00693  
                      00694 
                      00695  
                      00696  
                      00697 ;***************ID TABLE******************************
                      00698 
                      00699     ; Functional addr 11 bits 0x07DF
                      00700     ; Functional addr 29 bits 0x18DB33F1
                      00701 
                      00702 ;*********************************************
                      00703 ; Inicio de sesso
                      00704 ;   SID $01   Request current powertrain diagnostic data 
                      00705 ;   PID $00   Suported PIDs
                      00706 
                      00707 ;   0x07 0x01 0x00 0x0 0x0 0x0 0x0 0x0   
                      00708 
01BD                  00709 Init
01BD   0064           00710      clrwdt
                      00711      BANK1
01BE   1683               M         bsf     STATUS,5    ; Select page 1 
01BF   018C           00712      clrf PIE1_P
                      00713      
                      00714 
01C0   3006           00715      movlw b'00000110'
01C1   009F           00716      movwf ADCON1        ; Set PORTA Digital I/O
                      00717 
                      00718 
                      00719   ; TRM0 config 
01C2   3005           00720      movlw b'00000101'       ; configure Timer0
                      00721            ; 0-------       PORTB pull-up resistor enable 
                      00722            ; -0------       Interrupt falling edge RB0
                      00723            ; --0-----       TMR0 source clock internal(TOCS = 0)
                      00724            ; --------       TMR0 source edge of RA4/INT
                      00725            ; ----0---       prescaler assigned to Timer0 (PSA = 0)
                      00726            ; -----101       prescale = 1:64 (PS = 101)
                      00727                           ; TMR0 0.27127 * 64 = 17.361 
01C3   0081           00728      movwf OPTION_REG
                      00729 
                      00730    ; Clear BANK0
01C4   3020           00731      movlw 0x20
01C5   0084           00732      movwf FSR
01C6                  00733 jInitClr1
01C6   0180           00734      clrf INDF
01C7   0A84           00735      incf FSR,F
                      00736      jmpClr FSR,7, jInitClr1        
                          M  
01C8   1F84               M         btfss   FSR,7   
01C9   2???               M         goto    jInitClr1 
                      00737 
                      00738    ; Clear BANK1
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01CA   30A0           00739      movlw 0xA0
01CB   0084           00740      movwf FSR
01CC                  00741 jInitClr2
01CC   0180           00742      clrf INDF
01CD   0A84           00743      incf FSR,F
                      00744      jmpClr FSR,7, jInitClr2        
                          M  
01CE   1F84               M         btfss   FSR,7   
01CF   2???               M         goto    jInitClr2 
                      00745 
01D0   2???           00746      call InitIO
                      00747 
                      00748     ; config TIMER1
                      00749      BANK1
01D1   1683               M         bsf     STATUS,5    ; Select page 1 
01D2   140C           00750      bsf _TMR1IE_P   ; 00000001
                      00751 
                      00752      BANK0
01D3   1283               M         bcf     STATUS,5    ; Select page 0 
01D4   018F           00753      clrf TMR1H
01D5   018E           00754      clrf TMR1L
                      00755 
                      00756 ;     bsf INTCON, INTE
01D6   170B           00757      bsf INTCON,PEIE
01D7   178B           00758      bsf INTCON,GIE   ; 11000000
                      00759 
01D8   0008           00760      return
                      00761 
                      00762 
                      00763 ;************************************************
                      00764 
01D9                  00765 InitIO
                      00766      BANK0
01D9   1283               M         bcf     STATUS,5    ; Select page 0 
01DA   0185           00767      clrf PORTA
01DB   0186           00768      clrf PORTB
01DC   0187           00769      clrf PORTC
01DD   1507           00770      bsf PORTC,2
                      00771 
                      00772      BANK1
01DE   1683               M         bsf     STATUS,5    ; Select page 1 
                      00773      
                      00774      ; PORTA
                      00775      ;      0     display d4       
                      00776      ;      1     display d5       
                      00777      ;      2     display d6       
                      00778      ;      3     display d7       
                      00779      ;      4     display en       
                      00780      ;      5     display rs  
01DF   0185           00781      clrf TRISA     
                      00782 
                      00783      ; PORTB
                      00784      ;       0 in MCP2515 INT
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00785      ;       1 in key left
                      00786      ;       2 in key enter
                      00787      ;       3 in key right
                      00788      ;       4 in key down 
                      00789      ;       5 in key up 
                      00790      ;       6 -
                      00791      ;       7 -
01E0   30FF           00792      movlw b'11111111'
01E1   0086           00793      movwf TRISB
                      00794    
                      00795      ; PORTC
                      00796      ;      0   
                      00797      ;      1     
                      00798      ;      2   out CS  
                      00799      ;      3   out SPI clock - master 
                      00800      ;      4   in SPI data - SO
                      00801      ;      5   out SPI data out - SI
                      00802      ;      6   
                      00803      ;      7    
01E2   30D2           00804      movlw b'11010010'
01E3   0087           00805      movwf TRISC
                      00806      BANK0
01E4   1283               M         bcf     STATUS,5    ; Select page 0 
01E5   0008           00807      return
                      00808 
                      00809 
                      00810 
                      00811 ;**************************************************
                      00812 
                      00813 
                      00814 
                      00815 
                      00816 
                      00817 
                      00818 
                      00819 
                      00820 
01E6                  00821 WaitMSec
01E6   00B7           00822      movwf bCnt
01E7                  00823 jWaitMSec0
01E7   0064           00824      clrwdt
                      00825      Set1HClock bGenClk,4
01E8   080F               M            movfw TMR1H
01E9   3E04               M            addlw 4     
01EA   00BA               M            movwf bGenClk
01EB                  00826 jWaitMSec1
                      00827      jmp1HNotYet bGenClk,jWaitMSec1
                          M 
01EB   080F               M           movfw TMR1H
01EC   023A               M           subwf bGenClk,W
01ED   3980               M           andlw 0x80
                          M           jmpZ jWaitMSec1
01EE   1903               M         btfsc   _Z 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

01EF   2???               M         goto    jWaitMSec1 
01F0   0BB7           00828      decfsz bCnt,F
01F1   2???           00829      goto jWaitMSec0     
01F2   0008           00830      return
                      00831 
                      00832 
                      00833 
                      00834 
                      00835 ;****************************************************
                      00836 
                      00837 
                      00838    
                      00839     org 0x300
                      00840 
                      00841  
                      00842      
0300                  00843 GetSRegAddr:
0300   0782           00844     addwf PCL,F
0301   3400           00845     retlw reg0-reg0
0302   340E           00846     retlw reg1-reg0
0303   341C           00847     retlw reg2-reg0
0304   342A           00848     retlw reg3-reg0
0305   3438           00849     retlw reg4-reg0
0306   3446           00850     retlw reg5-reg0
0307   3454           00851     retlw reg6-reg0
0308   3462           00852     retlw reg7-reg0
0309   3470           00853     retlw reg8-reg0
030A   347E           00854     retlw reg9-reg0
030B   348C           00855     retlw reg10-reg0
030C   349A           00856     retlw reg11-reg0
030D   34A8           00857     retlw reg12-reg0
030E   34B6           00858     retlw reg13-reg0
030F   34C4           00859     retlw reg14-reg0
0310   34D2           00860     retlw reg15-reg0
0311   34E0           00861     retlw reg16-reg0
0312   34EE           00862     retlw reg17-reg0
                      00863  ;  retlw reg18-reg0
                      00864  ;  retlw reg19-reg0
                      00865   
                      00866 
                      00867 
                      00868 
0313                  00869 GetStrAddr:
0313   0782           00870     addwf PCL,F
0314   3400           00871     retlw Str0-Str0
0315   340A           00872     retlw Str1-Str0
0316   3419           00873     retlw Str2-Str0
0317   342E           00874     retlw Str3-Str0
0318   3436           00875     retlw Str4-Str0
0319   3443           00876     retlw Str5-Str0
031A   344F           00877     retlw Str6-Str0
031B   345D           00878     retlw Str7-Str0
031C   346A           00879     retlw Str8-Str0
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

031D   3477           00880     retlw Str9-Str0
                      00881 
                      00882 
031E                  00883 Strings
031E   0782           00884     addwf PCL, F
031F   3420 344F 3420 00885 Str0: dt " O B D 2 ",0x00
       3442 3420 3444 
       3420 3432 3420 
       3400 
0329   344E 3461 346F 00886 Str1: dt "Nao compativel",0x00  
       3420 3463 346F 
       346D 3470 3461 
       3474 3469 3476 
       3465 346C 3400 
0338   3443 3441 344E 00887 Str2: dt "CAN    bits/    Kbps",0x00 
       3420 3420 3420 
       3420 3462 3469 
       3474 3473 342F 
       3420 3420 3420 
       3420 344B 3462 
       3470 3473 3400 
034D   344D 3473 3467 00888 Str3: dt "Msg ID ",0x00 
       3420 3449 3444 
       3420 3400 
0355   3420 344E 346F 00889 Str4: dt " Normal mode",0x00     
       3472 346D 3461 
       346C 3420 346D 
       346F 3464 3465 
       3400 
0362   3420 3453 346C 00890 Str5: dt " Sleep mode",0x00     
       3465 3465 3470 
       3420 346D 346F 
       3464 3465 3400 
036E   344C 346F 346F 00891 Str6: dt "LoopBack mode",0x00     
       3470 3442 3461 
       3463 346B 3420 
       346D 346F 3464 
       3465 3400 
037C   3420 344C 3469 00892 Str7: dt " Listen mode",0x00     
       3473 3474 3465 
       346E 3420 346D 
       346F 3464 3465 
       3400 
0389   3420 3443 346F 00893 Str8: dt " Config mode",0x00  
       346E 3466 3469 
       3467 3420 346D 
       346F 3464 3465 
       3400 
0396   3445 346C 3465 00894 Str9: dt "Electro-Solucoes",0x00   
       3463 3474 3472 
       346F 342D 3453 
       346F 346C 3475 
       3463 346F 3465 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

       3473 3400 
                      00895 
                      00896 
                      00897        
                      00898    org 0x400
                      00899 
0400                  00900 RegNames
0400   0782           00901     addwf PCL, F
0401   3443 3441 344E 00902 reg0:  dt "CANSTAT    0x",0x00
       3453 3454 3441 
       3454 3420 3420 
       3420 3420 3430 
       3478 3400 
040F   3443 3441 344E 00903 reg1:  dt "CANCTRL    0x",0x00
       3443 3454 3452 
       344C 3420 3420 
       3420 3420 3430 
       3478 3400 
                      00904 ;reg2:  dt "TEC        0x",0x00 
                      00905 ;reg3:  dt "REC        0x",0x00
041D   3443 344E 3446 00906 reg2:  dt "CNF3       0x",0x00      
       3433 3420 3420 
       3420 3420 3420 
       3420 3420 3430 
       3478 3400 
042B   3443 344E 3446 00907 reg3:  dt "CNF2       0x",0x00
       3432 3420 3420 
       3420 3420 3420 
       3420 3420 3430 
       3478 3400 
0439   3443 344E 3446 00908 reg4:  dt "CNF1       0x",0x00
       3431 3420 3420 
       3420 3420 3420 
       3420 3420 3430 
       3478 3400 
0447   3443 3441 344E 00909 reg5:  dt "CANINTE    0x",0x00
       3449 344E 3454 
       3445 3420 3420 
       3420 3420 3430 
       3478 3400 
0455   3443 3441 344E 00910 reg6:  dt "CANINTF    0x",0x00
       3449 344E 3454 
       3446 3420 3420 
       3420 3420 3430 
       3478 3400 
0463   3445 3446 344C 00911 reg7:  dt "EFLG       0x",0x00
       3447 3420 3420 
       3420 3420 3420 
       3420 3420 3430 
       3478 3400 
0471   3454 3458 3442 00912 reg8: dt "TXB0CTRL   0x",0x00
       3430 3443 3454 
       3452 344C 3420 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

       3420 3420 3430 
       3478 3400 
047F   3454 3458 3442 00913  reg9: dt "TXB0SIDH   0x",0x00
       3430 3453 3449 
       3444 3448 3420 
       3420 3420 3430 
       3478 3400 
048D   3454 3458 3442 00914  reg10: dt "TXB0SIDL   0x",0x00
       3430 3453 3449 
       3444 344C 3420 
       3420 3420 3430 
       3478 3400 
049B   3452 3458 3442 00915 reg11: dt "RXB0CTRL   0x",0x00
       3430 3443 3454 
       3452 344C 3420 
       3420 3420 3430 
       3478 3400 
04A9   3452 3458 3442 00916 reg12: dt "RXB0SIDH   0x",0x00
       3430 3453 3449 
       3444 3448 3420 
       3420 3420 3430 
       3478 3400 
04B7   3452 3458 3442 00917 reg13: dt "RXB0SIDL   0x",0x00
       3430 3453 3449 
       3444 344C 3420 
       3420 3420 3430 
       3478 3400 
04C5   3452 3458 3442 00918 reg14: dt "RXB0EID8   0x",0x00
       3430 3445 3449 
       3444 3438 3420 
       3420 3420 3430 
       3478 3400 
04D3   3452 3458 3442 00919 reg15: dt "RXB0EID0   0x",0x00
       3430 3445 3449 
       3444 3430 3420 
       3420 3420 3430 
       3478 3400 
04E1   3454 3458 3442 00920 reg16: dt "TXB0DLC    0x",0x00 
       3430 3444 344C 
       3443 3420 3420 
       3420 3420 3430 
       3478 3400 
04EF   3454 3458 3442 00921 reg17: dt "TXB0DM     0x",0x00
       3430 3444 344D 
       3420 3420 3420 
       3420 3420 3430 
       3478 3400 
                      00922 
                      00923 
                      00924 
                      00925 ;******************************************
                      00926 
04FD                  00927 jSendFrame
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00928       ; Wait for pending message to be sent
                      00929      bL2bV   0x08, b2510RegMask
04FD   3008               M         movlw   0x08 
04FE   00CF               M         movwf   b2510RegMask 
04FF   3030           00930      movlw TXB0CTRL
0500   2???           00931      call WaitANDeqZ
                      00932     
                      00933     SPI_WriteL TXB0CTRL, 0x0B 
0501   300B               M           movlw     0x0B    
0502   00CE               M           movwf     b2510RegData 
0503   3030               M           movlw     0x30 
0504   2???               M           call      Wrt2510Reg 
                      00934     SPI_Rts RTS0       ; Transmit buffer 0
0505   3001               M           movlw     0x01  
0506   2???               M           call      Rts2510 
0507   0008           00935     return
                      00936 
                      00937 ;********************************************
                      00938 
                      00939 
                      00940 ;     SyncSeg = 1TQ
                      00941 ;     PropSeg = 1->8TQ
                      00942 ;     PS1     = 1->8TQ
                      00943 ;     PS2     = 2->8TQ
                      00944 
0508                  00945 Init1      
0508   2???           00946    call Reset2510
                      00947   ; wait 128 cicles
0509   30FF           00948     movlw 0xff
050A   2???           00949     call delay_ms
                      00950 
050B   1CE2           00951     btfss baudrate_flag
050C   2???           00952     goto jlow 
                      00953     ; 500Khz
                      00954     SPI_WriteL CNF1, 0x41   ;   
050D   3041               M           movlw     0x41    
050E   00CE               M           movwf     b2510RegData 
050F   302A               M           movlw     0x2A 
0510   2???               M           call      Wrt2510Reg 
                      00955     SPI_WriteL CNF2, 0xBA   ;
0511   30BA               M           movlw     0xBA    
0512   00CE               M           movwf     b2510RegData 
0513   3029               M           movlw     0x29 
0514   2???               M           call      Wrt2510Reg 
                      00956     SPI_WriteL CNF3, 0x06   ;
0515   3006               M           movlw     0x06    
0516   00CE               M           movwf     b2510RegData 
0517   3028               M           movlw     0x28 
0518   2???               M           call      Wrt2510Reg 
0519   2???           00957     goto brdone
051A                  00958 jlow
                      00959     ; 250Khz
                      00960     SPI_WriteL CNF1, 0x42   ;   
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

051A   3042               M           movlw     0x42    
051B   00CE               M           movwf     b2510RegData 
051C   302A               M           movlw     0x2A 
051D   2???               M           call      Wrt2510Reg 
                      00961     SPI_WriteL CNF2, 0xBA   ;
051E   30BA               M           movlw     0xBA    
051F   00CE               M           movwf     b2510RegData 
0520   3029               M           movlw     0x29 
0521   2???               M           call      Wrt2510Reg 
                      00962     SPI_WriteL CNF3, 0x06   ;
0522   3006               M           movlw     0x06    
0523   00CE               M           movwf     b2510RegData 
0524   3028               M           movlw     0x28 
0525   2???               M           call      Wrt2510Reg 
0526                  00963 brdone
                      00964     SPI_WriteL CANINTE,0x00
0526   3000               M           movlw     0x00    
0527   00CE               M           movwf     b2510RegData 
0528   302B               M           movlw     0x2B 
0529   2???               M           call      Wrt2510Reg 
                      00965     SPI_WriteL CANINTF,0x00 
052A   3000               M           movlw     0x00    
052B   00CE               M           movwf     b2510RegData 
052C   302C               M           movlw     0x2C 
052D   2???               M           call      Wrt2510Reg 
                      00966     SPI_WriteL TXB0CTRL,0x00  
052E   3000               M           movlw     0x00    
052F   00CE               M           movwf     b2510RegData 
0530   3030               M           movlw     0x30 
0531   2???               M           call      Wrt2510Reg 
                      00967     SPI_WriteL TXB1CTRL,0x00  
0532   3000               M           movlw     0x00    
0533   00CE               M           movwf     b2510RegData 
0534   3040               M           movlw     0x40 
0535   2???               M           call      Wrt2510Reg 
                      00968     SPI_WriteL TXB2CTRL,0x00  
0536   3000               M           movlw     0x00    
0537   00CE               M           movwf     b2510RegData 
0538   3050               M           movlw     0x50 
0539   2???               M           call      Wrt2510Reg 
                      00969     SPI_WriteL RXB0CTRL,0x60 ;  turn Mask/Filter OFF | Roll Over ON
053A   3060               M           movlw     0x60    
053B   00CE               M           movwf     b2510RegData 
053C   3060               M           movlw     0x60 
053D   2???               M           call      Wrt2510Reg 
                      00970  
053E   1C62           00971     btfss frametype_flag
053F   2???           00972     call CfgSTDMask
0540   1862           00973     btfsc frametype_flag
0541   2???           00974     call CfgExMask
                      00975 
                      00976     bL2bV 0x1F, b2510RegMask  
0542   301F               M         movlw   0x1F 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0543   00CF               M         movwf   b2510RegMask 
                      00977     bL2bV 0x00, b2510RegData
0544   3000               M         movlw   0x00 
0545   00CE               M         movwf   b2510RegData 
0546   300F           00978     movlw CANCTRL
0547   2???           00979     call BitMod2510
                      00980 
                      00981 ;    movlw 0x00      ; NORMAL_MODE
                      00982  ;   call Set2510Mode
0548   2???           00983     call SetLoopBackMode 
                      00984 
                      00985    
0549                  00986 jCANFrameData
                      00987      ; Set to DataFrame|SzFrame
                      00988      SPI_WriteL TXB0DLC, 0x02    ; data frame | n data bytes
0549   3002               M           movlw     0x02    
054A   00CE               M           movwf     b2510RegData 
054B   3035               M           movlw     0x35 
054C   2???               M           call      Wrt2510Reg 
                      00989      
                      00990     ; Send least significante byte first
                      00991      SPI_WriteL TXB0D0, 0x01  ; SID $01
054D   3001               M           movlw     0x01    
054E   00CE               M           movwf     b2510RegData 
054F   3036               M           movlw     0x36 
0550   2???               M           call      Wrt2510Reg 
                      00992      SPI_WriteL TXB0D1, 0x00  ; PID $00
0551   3000               M           movlw     0x00    
0552   00CE               M           movwf     b2510RegData 
0553   3037               M           movlw     0x37 
0554   2???               M           call      Wrt2510Reg 
                      00993  
                      00994 
                      00995      
0555   0008           00996     return
                      00997 
                      00998 ;**************************************************
                      00999 
0556                  01000 CfgFunc
                      01001     ; SPI_WriteL CANCTRL,0x98  ;set config mode
                      01002     ; abort all pending transmitions
                      01003 ;     movlw 0x80
                      01004 ;     call Set2510Mode
0556   3083           01005      movlw LCDL1+3
0557   2???           01006      call LCDcomd
                      01007 
                      01008      SPI_Read CANSTAT
0558   300E               M           movlw     0x0E 
0559   2???               M           call      Rd2510Reg 
055A   00E5           01009      movwf cdata
Message[305]: Using default destination of 1 (file).
055B   0EE5           01010      swapf cdata 
055C   1003           01011      bcf _C   
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

055D   0CE5           01012      rrf  cdata,F 
055E   0865           01013      movfw cdata
055F   3E04           01014      addlw 4
0560   2???           01015      call LCDText
0561   2???           01016      call Refresh
0562   16E2           01017      bsf config_mode
0563   0008           01018      return
                      01019 
                      01020 ;*********************************************************
                      01021 
                      01022 
                      01023 
0564                  01024 Refresh
0564   3094           01025      movlw LCDL3
0565   2???           01026      call LCDcomd
0566   0867           01027      movfw cIdx
0567   2???           01028      call LCD_RegString
0568   30??           01029      movlw high getRegAddr
0569   008A           01030      movwf PCLATH
056A   0867           01031      movfw cIdx
056B   2???           01032      call getRegAddr
056C   2???           01033      call Rd2510Reg  
056D   00E5           01034      movwf cdata   
056E   2???           01035      call LCD_Hex
056F   0008           01036      return
                      01037 
0570                  01038 getRegAddr
0570   0782           01039      addwf PCL,F
0571   340E           01040      retlw 0x0E   ; CANSTAT
0572   340F           01041      retlw 0x0F   ; CANCTRL
                      01042 ;     retlw 0x1C   ; TEC
                      01043 ;     retlw 0x1D   ;REC
0573   3428           01044      retlw 0x28   ;CNF3
0574   3429           01045      retlw 0x29   ; CNF2
0575   342A           01046      retlw 0x2A   ; CNF1
0576   342B           01047      retlw 0x2B   ;CANINTE
0577   342C           01048      retlw 0x2C   ; CANINTF
0578   342D           01049      retlw 0x2D  ; EFLG
0579   3430           01050      retlw 0x30  ; TXB0CTRL
057A   3431           01051       retlw 0x31  ; TXB0SIDH
057B   3432           01052       retlw 0x32  ; TXB0SIDL
057C   3460           01053      retlw 0x60  ; RXB0CTRL
057D   3461           01054      retlw 0x61  ; RXB0SIDH
057E   3462           01055      retlw 0x62  ; RXB0SIDL
057F   3463           01056      retlw 0x63  ; RXB0EID8
0580   3464           01057      retlw 0x64  ; RXB0EID0
0581   3435           01058      retlw 0x35  ; TXD0DLC
0582   3436           01059      retlw 0x36  ; TXB0DM
                      01060      
                      01061 
                      01062 ;******************************************************************************
                      01063 
                      01064 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01065 
                      01066 
0583                  01067 Key_Left
0583   1F62           01068      btfss data_nibble
0584   2???           01069      goto AdjRew
0585   1362           01070      bcf data_nibble
0586   30A1           01071      movlw LCDL3+13
0587   2???           01072      call LCDcomd        
0588   0008           01073      return
0589                  01074 AdjRew
0589   1FE2           01075      btfss menu_stage
058A   2???           01076      goto normal_func
058B   13E2           01077      bcf menu_stage
058C   300C           01078      movlw 0x0c
058D   2???           01079      call LCDcomd
058E   0008           01080      return
058F                  01081 normal_func
058F   3001           01082      movlw LCDCLR
0590   2???           01083      call LCDcomd
0591   3085           01084      movlw LCDL1+5
0592   2???           01085      call LCDcomd
                      01086     ; set normal mode
                      01087 ;     movlw 0x00
                      01088 ;      call Set2510Mode 
0593   3000           01089      movlw 0
0594   2???           01090      call LCDText 
                      01091 ;     LCD_Text 1,"      O B D 2"
0595   12E2           01092      bcf config_mode
                      01093     ; set default
0596   1062           01094      bcf CanType, 0   ; default 11 bits
0597   14E2           01095      bsf CanType,1    ; default 500Khz
0598   2???           01096      goto jSendFrame
0599   0008           01097      return
                      01098           
                      01099 
059A                  01100 Key_Right
059A   1BE2           01101      btfsc menu_stage
059B   2???           01102      goto AdjFw
059C   17E2           01103      bsf  menu_stage
059D   30A1           01104      movlw LCDL3+13
059E   2???           01105      call LCDcomd
059F   300F           01106       movlw 0x0f
05A0   2???           01107       call LCDcomd
05A1   0008           01108      return
05A2                  01109 AdjFw
05A2   1B62           01110      btfsc data_nibble
05A3   0008           01111      return
05A4   1762           01112      bsf data_nibble
05A5   30A2           01113      movlw LCDL3+14
05A6   2???           01114      call LCDcomd        
05A7   0008           01115      return
                      01116 
                      01117 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05A8                  01118 Key_Down
05A8   1BE2           01119      btfsc menu_stage
05A9   2???           01120      goto wrmode3
05AA   0867           01121      movf cIdx,W
05AB   1903           01122      btfsc _Z
05AC   0008           01123      return
Message[305]: Using default destination of 1 (file).
05AD   03E7           01124      decf cIdx
05AE   2???           01125      goto Refresh
05AF                  01126 wrmode3
05AF   3001           01127      movlw 0x01
05B0   1F62           01128      btfss data_nibble
05B1   3010           01129      movlw 0x10
Message[305]: Using default destination of 1 (file).
05B2   02E5           01130      subwf cdata
05B3   0865           01131      movfw cdata
05B4   1F62           01132      btfss data_nibble
05B5   0E65           01133      swapf cdata,W
05B6   390F           01134      andlw 0x0f
05B7   2???           01135      call getCH    
05B8   2???           01136      call LCDdata
05B9   30A1           01137      movlw LCDL3+13
05BA   1B62           01138      btfsc data_nibble
05BB   30A2           01139      movlw LCDL3+14
05BC   2???           01140      call LCDcomd        
05BD   0008           01141      return
                      01142 
                      01143 
05BE                  01144 Key_Up
05BE   1BE2           01145      btfsc menu_stage
05BF   2???           01146      goto wrmode4
05C0   0867           01147      movfw  cIdx    
05C1   3C10           01148      sublw 16
05C2   1C03           01149      btfss _C
05C3   0008           01150      return
Message[305]: Using default destination of 1 (file).
05C4   0AE7           01151      incf cIdx
05C5   2???           01152      goto Refresh
05C6                  01153 wrmode4
05C6   3001           01154      movlw 0x01
05C7   1F62           01155      btfss data_nibble
05C8   3010           01156      movlw 0x10
Message[305]: Using default destination of 1 (file).
05C9   07E5           01157      addwf cdata 
05CA   0865           01158      movfw cdata
05CB   1F62           01159      btfss data_nibble
05CC   0E65           01160      swapf cdata,W
05CD   390F           01161      andlw 0x0f
05CE   2???           01162      call getCH    
05CF   2???           01163      call LCDdata     
05D0   30A1           01164      movlw LCDL3+13
05D1   1B62           01165      btfsc data_nibble
05D2   30A2           01166      movlw LCDL3+14
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

05D3   2???           01167      call LCDcomd        
                      01168      
05D4   0008           01169      return
                      01170 
                      01171 
05D5                  01172 Key_Enter
05D5   1FE2           01173      btfss menu_stage
05D6   0008           01174      return
05D7   30??           01175      movlw high getRegAddr
05D8   008A           01176      movwf PCLATH
05D9   0865           01177      movfw cdata
05DA   00CE           01178      movwf b2510RegData
05DB   0867           01179      movfw cIdx
05DC   2???           01180      call getRegAddr
05DD   00CD           01181      movwf b2510RegAdr
05DE   30??           01182      movlw high Wrt2510Reg
05DF   008A           01183      movwf PCLATH
05E0   084D           01184      movfw b2510RegAdr
05E1   2???           01185      call Wrt2510Reg 
05E2   300C           01186       movlw LCDCONT
05E3   2???           01187       call LCDcomd
05E4   1362           01188      bcf data_nibble
05E5   13E2           01189      bcf menu_stage
05E6   0008           01190      return
                      01191 
                      01192 
                      01193 ;*******************************************************
                      01194 
                      01195 
                      01196 
05E7                  01197 CfgSTDMask
                      01198 
                      01199     SPI_WriteL RXM0SIDH, 0xFF
05E7   30FF               M           movlw     0xFF    
05E8   00CE               M           movwf     b2510RegData 
05E9   3020               M           movlw     0x20 
05EA   2???               M           call      Wrt2510Reg 
                      01200     SPI_WriteL RXM0SIDL, 0xE0
05EB   30E0               M           movlw     0xE0    
05EC   00CE               M           movwf     b2510RegData 
05ED   3021               M           movlw     0x21 
05EE   2???               M           call      Wrt2510Reg 
                      01201 
                      01202     SPI_WriteL RXF0SIDH, 0xFF
05EF   30FF               M           movlw     0xFF    
05F0   00CE               M           movwf     b2510RegData 
05F1   3000               M           movlw     0x00 
05F2   2???               M           call      Wrt2510Reg 
                      01203     SPI_WriteL RXF0SIDL, 0xFF
05F3   30FF               M           movlw     0xFF    
05F4   00CE               M           movwf     b2510RegData 
05F5   3001               M           movlw     0x01 
05F6   2???               M           call      Wrt2510Reg 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01204     
                      01205     SPI_WriteL TXB0SIDH, 0xFB  ; message ID
05F7   30FB               M           movlw     0xFB    
05F8   00CE               M           movwf     b2510RegData 
05F9   3031               M           movlw     0x31 
05FA   2???               M           call      Wrt2510Reg 
                      01206      SPI_WriteL TXB0SIDL, 0xE0  ;                      
05FB   30E0               M           movlw     0xE0    
05FC   00CE               M           movwf     b2510RegData 
05FD   3032               M           movlw     0x32 
05FE   2???               M           call      Wrt2510Reg 
05FF   0008           01207     return
                      01208 
                      01209 
                      01210 
                      01211 ;***********************************************
                      01212 
0600                  01213 CfgExMask
                      01214 
                      01215     SPI_WriteL RXF0EID8, 0x1b
0600   301B               M           movlw     0x1b    
0601   00CE               M           movwf     b2510RegData 
0602   3002               M           movlw     0x02 
0603   2???               M           call      Wrt2510Reg 
                      01216     SPI_WriteL RXF0EID0, 0x66
0604   3066               M           movlw     0x66    
0605   00CE               M           movwf     b2510RegData 
0606   3003               M           movlw     0x03 
0607   2???               M           call      Wrt2510Reg 
                      01217 
                      01218     SPI_WriteL RXF0SIDH, 0x7e
0608   307E               M           movlw     0x7e    
0609   00CE               M           movwf     b2510RegData 
060A   3000               M           movlw     0x00 
060B   2???               M           call      Wrt2510Reg 
                      01219     SPI_WriteL RXF0SIDL, 0x2b
060C   302B               M           movlw     0x2b    
060D   00CE               M           movwf     b2510RegData 
060E   3001               M           movlw     0x01 
060F   2???               M           call      Wrt2510Reg 
                      01220 
                      01221     SPI_WriteL RXM0EID8, 0xFF
0610   30FF               M           movlw     0xFF    
0611   00CE               M           movwf     b2510RegData 
0612   3022               M           movlw     0x22 
0613   2???               M           call      Wrt2510Reg 
                      01222     SPI_WriteL RXM0EID0, 0xFF
0614   30FF               M           movlw     0xFF    
0615   00CE               M           movwf     b2510RegData 
0616   3023               M           movlw     0x23 
0617   2???               M           call      Wrt2510Reg 
                      01223 
                      01224     SPI_WriteL RXM0SIDH, 0xFF
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0618   30FF               M           movlw     0xFF    
0619   00CE               M           movwf     b2510RegData 
061A   3020               M           movlw     0x20 
061B   2???               M           call      Wrt2510Reg 
                      01225     SPI_WriteL RXM0SIDL, 0xFF
061C   30FF               M           movlw     0xFF    
061D   00CE               M           movwf     b2510RegData 
061E   3021               M           movlw     0x21 
061F   2???               M           call      Wrt2510Reg 
                      01226 
                      01227  
                      01228      SPI_WriteL TXB0SIDL, 0x2B  ; message ID
0620   302B               M           movlw     0x2B    
0621   00CE               M           movwf     b2510RegData 
0622   3032               M           movlw     0x32 
0623   2???               M           call      Wrt2510Reg 
                      01229      SPI_WriteL TXB0SIDH, 0x7E  ; SID|ExFrame|ExID 
0624   307E               M           movlw     0x7E    
0625   00CE               M           movwf     b2510RegData 
0626   3031               M           movlw     0x31 
0627   2???               M           call      Wrt2510Reg 
                      01230      SPI_WriteL TXB0EID0, 0x66  ; message ExID
0628   3066               M           movlw     0x66    
0629   00CE               M           movwf     b2510RegData 
062A   3034               M           movlw     0x34 
062B   2???               M           call      Wrt2510Reg 
                      01231      SPI_WriteL TXB0EID8, 0x1B  ;  
062C   301B               M           movlw     0x1B    
062D   00CE               M           movwf     b2510RegData 
062E   3033               M           movlw     0x33 
062F   2???               M           call      Wrt2510Reg 
                      01232 
0630   0008           01233     return
                      01234 
                      01235 
                      01236 
                      01237 ;***********************************************
                      01238 
                      01239 
                      01240 ;Init2510 
                      01241 
                      01242 ;   call Reset2510
                      01243     ; ---0----     abort all pending msg
                      01244     ; ----1---     one shot tx
                      01245     ; -----0--     disable ClkOut
                      01246 
                      01247   ; wait 128 cicles
                      01248 ;    movlw 0xff
                      01249 ;    call delay_ms
                      01250 
                      01251 ;    bL2bV 0x1C, b2510RegMask  
                      01252 ;    bL2bV 0x08, b2510RegData
                      01253 ;    movlw CANCTRL
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01254 ;    call BitMod2510
                      01255 
                      01256   
                      01257      
                      01258 
                      01259     ; set MCP2515 interrupts
                      01260     ;  0-------    Error on TX/RX message  
                      01261     ;  -0------    CAN bus activity
                      01262     ;  --0-----    Interrupt on EFLAG reg
                      01263     ;  ---0----    TXB2 empty
                      01264     ;  ------1-    Messsage received on RXB1
                      01265     ;  -------1    Messsage received on RXB0
                      01266 
                      01267 ;   SPI_WriteL CANINTE,0x00
                      01268   
                      01269 
                      01270 ;    btfss CanType,0
                      01271 ;    call  CfgSTDMask
                      01272 ;    btfsc CanType,0
                      01273 ;    call  CfgExMask
                      01274  
                      01275 
                      01276     ; x00-----  receive all valid message using filter criteria
                      01277     ; x----000  accept filter 0
                      01278  ;;   SPI_Write RXB1CTRL, 0x00 
                      01279 
                      01280 ;    btfss CanType,1
                      01281 ;    goto LowBRP
                      01282 
                      01283     ; Set physical layer configuration
                      01284     ;  16TQ
                      01285     ; Fosc       = 16Mhz : 500Kbits/s
                      01286     ; BRP        = 1  
                      01287     ; Sync Seg   = 1TQ
                      01288     ; Prop Seg   = 2TQ
                      01289     ; Phase Seg1 = 10TQ
                      01290     ; Phase Seg2 = 3TQ
                      01291     ;
                      01292     ; TQ = 2 * (1/Fosc) * (BRP+1)
                      01293     ;
                      01294   
                      01295 
                      01296     ; Hi_BRP 500Kb/s
                      01297     ;  BRP=1
                      01298     ; Sync Seg = 1TQ 0x00
                      01299 ;    SPI_WriteL CNF1, 0x01   ;   set BRP 
                      01300     ; BTLMODE_CNF3   0x80
                      01301     ; SMPL_1X        0x40
                      01302     ; PHSEG1 = 10QT  0x10
                      01303     ; PropSeg = 2QT  0x0A
                      01304 ;    SPI_WriteL CNF2, 0xDA   ;
                      01305     ; SOF = 0 - WAKFIL = 0 - PHSEG2 = 2QT
                      01306 ;    SPI_WriteL CNF3, 0x03   ;
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01307  
                      01308 ;    goto CfgBRPDone
                      01309 ;LowBRP
                      01310     ; Low_BRP 250Kb/s
                      01311  
                      01312     ;  16TQ
                      01313     ; Fosc       = 16Mhz : 500Kbits/s
                      01314     ; SJW=0 - BRP=2 
                      01315     ; Sync Seg   = 1TQ
                      01316     ; Prop Seg   = 2TQ
                      01317     ; Phase Seg1 = 10TQ
                      01318     ; Phase Seg2 = 3TQ
                      01319 ;   SPI_WriteL CNF1, 0x01   ;   
                      01320 ;    SPI_WriteL CNF2, 0xF2   ;
                      01321 ;    SPI_WriteL CNF3, 0x03   ;
                      01322 
                      01323 
                      01324     ; Config RX registers  
                      01325    
                      01326     ; x00x----  RXM   turn on mask/filter
                      01327     ; x--x-1--  BUKT  RXB0 msg roll over
                      01328 
                      01329 ;    SPI_WriteL RXB0CTRL,  0x64
                      01330 
                      01331 ;     bL2bV 0x0B, b2510RegMask
                      01332 ;     bL2bV 0x0B, b2510RegData
                      01333 ;     movlw TXB0CTRL
                      01334 ;     call BitMod2510
                      01335 
                      01336  
                      01337     ;    125Kb/s
                      01338     ; BaundRate=Fxtal/(2*(BPR+1)*(3+TSEG1+TSEG2))
                      01339 
                      01340 ;CfgBRPDone
                      01341 
                      01342 ;       call SetNormalMode
                      01343   ;    call SetLoopBackMode
                      01344    ;  call SetListenMode
                      01345 ;       movlw 0x80
                      01346 ;      call delay_ms
                      01347     
                      01348   ; InitializeOBD2 by detecting Baud rate
                      01349 
                      01350      ; Wait for pending message to be sent
                      01351 ;jSendFrame
                      01352 ;     bL2bV   0x08, b2510RegMask
                      01353 ;     movlw TXB0CTRL
                      01354 ;     call WaitANDeqZ
                      01355 
                      01356      ; Send CAN frame  
                      01357 
                      01358 ;      btfsc CanType,0
                      01359 ;     goto jExCANFrame
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01360      
                      01361   
                      01362 
                      01363      ; Send CAN Standard frame
                      01364      ; Functional addr   0x7DF
                      01365      ; Physical request ECU1 addr  0x7E0 
                      01366      ; Physical respond ECU1 addr  0x7E8  
                      01367 
                      01368      
                      01369     
                      01370 ;     SPI_WriteL TXB0SIDH, 0xFB  ; message ID
                      01371 ;     SPI_WriteL TXB0SIDL, 0xE0  ;                      
                      01372 ;     goto jCANFrameData
                      01373 
                      01374 ;jExCANFrame
                      01375     
                      01376  
                      01377 
                      01378      ; Send CAN Extended frame 
                      01379      ; Functional addr 0x 18 DB 33 F1
                      01380      ; Physical request addr 0x 18 DA xx F1 ( ECU#xx )
                      01381      ; Physical respond addr 0x 18 DA F1 xx ( ECU#xx )
                      01382 
                      01383 ;     SPI_WriteL TXB0SIDL, 0x2B  ; message ID
                      01384 ;     SPI_WriteL TXB0SIDH, 0x7E  ; SID|ExFrame|ExID 
                      01385 ;     SPI_WriteL TXB0EID0, 0x66  ; message ExID
                      01386 ;     SPI_WriteL TXB0EID8, 0x1B  ;  
                      01387 ;jCANFrameData
                      01388      ; Set to RemoteFrame|SzFrame
                      01389 ;     SPI_WriteL TXB0DLC, 0x42      ; n data bytes
                      01390      
                      01391     ; Send least significante byte first
                      01392 ;     SPI_WriteL TXB0D0, 0x01  ; SID $01
                      01393 ;     SPI_WriteL TXB0D1, 0x00  ; PID $00
                      01394  
                      01395      
                      01396 ;    SPI_Rts RTS0       ; Transmit buffer 0
                      01397 
                      01398 
                      01399  ;     Set1HClock bGenClk,200   ; 0xc8 Wait 56ms for response
                      01400  ;     bsf T1CON,TMR1ON 
                      01401     
                      01402 ;jWaitAnswer
                      01403 ;      SPI_Read TXB0CTRL
                      01404 ;      andlw 0x70
                      01405 ;      btfss _Z     
                      01406 ;      goto tx_err
                      01407 ;      movfw TMR1L
                      01408 ;      subwf bGenClk,W
                      01409 ;         btfsc   _C ;
                      01410 ;         goto   jWaitAnswer
                      01411 ;      goto pass2
                      01412 ;tx_err  
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01413 ;    bsf ertx_flag     
                      01414 ;    bL2bV 0x08,b2510RegMask
                      01415 ;    bL2bV 0x00, b2510RegData
                      01416 ;    movlw TXB0CTRL
                      01417 ;    call BitMod2510 
                      01418 ;pass2
                      01419 ;      clrf TMR1H
                      01420 ;      clrf TMR1L
                      01421 ;      bcf T1CON,TMR1ON 
                      01422 
                      01423 ;     SPI_Read CANINTF
                      01424 ;     movwf SaveReg   ; save reg
                      01425 ;     andlw 0x80   ; see  MERR|ERRIF
                      01426      
                      01427 ;     SPI_WriteL CANINTF,0x00
                      01428    
                      01429 ;     btfsc ertx_flag
                      01430 ;     goto  jCfgBRP  
                      01431      ; No errors; Check Msg
                      01432 ;     movfw SaveReg
                      01433 ;     andlw 0x03
                      01434 ;     btfss _Z
                      01435 ;     retlw 2   ; return CAN msg received
                      01436 ;     movfw CanType
                      01437 ;     andlw 0x01
                      01438 ;     btfss _Z
                      01439 ;     retlw 0x01      ; return no compatible 
                      01440 ;     movlw 0x01
                      01441 ;     iorwf CanType
                      01442 ;     goto jSendFrame
                      01443 
                      01444 
                      01445 ;jCfgBRP
                      01446 ;    btfss CanType,1
                      01447 ;    retlw  0x01   ; no compativel
                      01448 
                      01449     ; Clear error flag on CANINTF   
                      01450 ;    bL2bV 0xA0,b2510RegMask
                      01451 ;    bL2bV 0x00, b2510RegData
                      01452 ;    movlw CANINTF
                      01453 ;    call BitMod2510
                      01454   
                      01455 
                      01456 ;    call SetConfigMode
                      01457 ;    movlw 0x80
                      01458 ;    call delay_ms
                      01459 ;    goto LowBRP
                      01460     
                      01461 
                      01462 ;******************************************
                      01463 
                      01464  
                      01465 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01466 
                      01467 ;**********************************************
                      01468 
                      01469 
                      01470 
                      01471 
0631                  01472 LCD_RegString
                      01473  
0631   00AD           01474     movwf STR_NUM
0632   30??           01475    movlw high GetSRegAddr
0633   008A           01476    movwf PCLATH
0634   082D           01477    movf STR_NUM,W
0635   2???           01478    call GetSRegAddr
0636   00AE           01479    movwf INDEX
0637                  01480 next
0637   30??           01481    movlw high RegNames
0638   008A           01482    movwf PCLATH
                      01483 
0639   082E           01484     movf INDEX,W
063A   2???           01485     call RegNames
063B   3E00           01486     addlw d'0'
063C   1903           01487     btfsc STATUS,Z
063D   2???           01488     goto done
                      01489   
063E   2???           01490     call LCDdata
063F   0AAE           01491     incf INDEX, F
                      01492 
0640   2???           01493     goto next
0641                  01494 done
                      01495 
0641   0008           01496     return
                      01497 
                      01498 ;*****************************************************
                      01499 
                      01500 
0642                  01501 LCDText
                      01502  
0642   00AD           01503     movwf STR_NUM
0643   30??           01504    movlw high GetStrAddr
0644   008A           01505    movwf PCLATH
0645   082D           01506    movf STR_NUM,W
0646   2???           01507    call GetStrAddr
0647   00AE           01508    movwf INDEX
0648   30??           01509    movlw high Strings
0649   008A           01510    movwf PCLATH
064A                  01511 next1 
064A   082E           01512     movf INDEX,W
064B   2???           01513     call Strings
064C   3E00           01514     addlw d'0'
064D   1903           01515     btfsc STATUS,Z
064E   2???           01516     goto done1
                      01517   
064F   2???           01518     call LCDdata
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0650   0AAE           01519     incf INDEX, F
                      01520 
0651   2???           01521     goto next1
0652                  01522 done1
                      01523 
0652   0008           01524     return
                      01525 
                      01526 ;*****************************************************
                      01527 
0653                  01528 LCD_Hex
0653   00A3           01529     movwf LO
0654   00A5           01530     movwf LO_TEMP
0655   12AC           01531     bcf BCflag
0656   3010           01532     movlw 0x10
0657   00A9           01533     movwf TEMP2
0658   2???           01534     call _Hex08
0659   2???           01535     call LCDdata
065A   3001           01536     movlw 1
065B   00A9           01537     movwf TEMP2
065C   16AC           01538     bsf BCflag
065D   2???           01539     call _Hex08
065E   2???           01540     call LCDdata
065F   0008           01541     return
                      01542 
                      01543 
0660                  01544 getCH
0660   0782           01545      addwf PCL,F
0661   3430           01546      retlw '0'
0662   3431           01547      retlw '1'
0663   3432           01548      retlw '2'
0664   3433           01549      retlw '3'
0665   3434           01550      retlw '4'
0666   3435           01551      retlw '5'
0667   3436           01552      retlw '6'
0668   3437           01553      retlw '7'
0669   3438           01554      retlw '8'
066A   3439           01555      retlw '9'
066B   3441           01556      retlw 'A'
066C   3442           01557      retlw 'B'
066D   3443           01558      retlw 'C'
066E   3444           01559      retlw 'D'
066F   3445           01560      retlw 'E'
0670   3446           01561      retlw 'F'
                      01562     
                      01563 
0671                  01564 _Hex08
0671   01A7           01565      clrf TEMP1
0672   0829           01566      movfw TEMP2
0673                  01567 _V08_H
0673   0225           01568      subwf LO_TEMP,W
0674   1C03           01569      skpc
0675   2???           01570      goto _VH8_LCD
0676   0AA7           01571      incf TEMP1,F
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0677   0829           01572      movfw TEMP2
0678   02A5           01573      subwf LO_TEMP,F
0679   16AC           01574      bsf BCflag
067A   2???           01575      goto _V08_H    
067B                  01576 _VH8_LCD
                      01577 
067B   30??           01578      movlw high getCH
067C   008A           01579      movwf PCLATH
067D   0827           01580      movfw TEMP1
067E   2???           01581      call getCH
067F   0008           01582      return
                      01583 
                      01584 
                      01585 ;*****************************************************
                      01586 
                      01587 
                      01588 
0680                  01589 LCDval08
                      01590  
0680   00A3           01591         movwf   LO
0681   00A5           01592         movwf   LO_TEMP         ; LO -> LO_TEMP
0682   12AC           01593         bcf     BCflag          ; blank checker for preceeding zeros
                      01594 
0683   3064           01595         movlw   d'100'          ; check amount of 100s
0684   00A9           01596         movwf   TEMP2           ; ==> Decimal Range 0 - 255 <=> 8 bit
0685   2???           01597         call    _VALcnv08       ; call conversion sub-routine
                      01598         LCDw                    ; call LCD sub-routine with value stored in w
0686   2???               M         call    LCDdata
                      01599 
0687   300A           01600         movlw   d'10'           ; check amount of 10s
0688   00A9           01601         movwf   TEMP2
0689   2???           01602         call    _VALcnv08       ; call conversion sub-routine
                      01603         LCDw                    ; call LCD sub-routine with value stored in w
068A   2???               M         call    LCDdata
                      01604 
068B   3001           01605         movlw   d'1'            ; check amount of 1s
068C   00A9           01606         movwf   TEMP2
068D   16AC           01607         bsf     BCflag          ; remove blank checker in case of zero
068E   2???           01608         call    _VALcnv08       ; call conversion sub-routine
                      01609         LCDw                    ; call LCD sub-routine with value stored in w
068F   2???               M         call    LCDdata
                      01610  
0690   0008           01611         RETURN
                      01612  
                      01613 
                      01614 ;*****************************************************
                      01615 
                      01616 
0691                  01617 LCDval16
                      01618  
0691   0823           01619         movfw   LO              ; LO -> LO_TEMP
0692   00A5           01620         movwf   LO_TEMP
0693   0824           01621         movfw   HI              ; HI -> HI_TEMP
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0694   00A6           01622         movwf   HI_TEMP
0695   12AC           01623         bcf     BCflag          ; Blank checker for preceeding zeros
                      01624 
0696   3010           01625         movlw   b'00010000'     ; check amount of 10000s
0697   00A9           01626         movwf   TEMP2           ; Sub-LO
0698   3027           01627         movlw   b'00100111'
0699   00A8           01628         movwf   TEMP3           ; Sub-HI
069A   2???           01629         call    _VALcnv16       ; call conversion sub-routine
                      01630         LCDw                    ; call LCD sub-routine with value stored in w
069B   2???               M         call    LCDdata
                      01631 
069C   30E8           01632         movlw   b'11101000'     ; check amount of 1000s
069D   00A9           01633         movwf   TEMP2           ; Sub-LO
069E   3003           01634         movlw   b'00000011'
069F   00A8           01635         movwf   TEMP3           ; Sub-HI
06A0   2???           01636         call    _VALcnv16       ; call conversion sub-routine
                      01637         LCDw                    ; call LCD sub-routine with value stored in w
06A1   2???               M         call    LCDdata
                      01638 
06A2   3064           01639         movlw   b'01100100'     ; check amount of 100s
06A3   00A9           01640         movwf   TEMP2           ; Sub-LO
06A4   01A8           01641         clrf    TEMP3           ; Sub-HI is zero
06A5   2???           01642         call    _VALcnv16       ; call conversion sub-routine
                      01643         LCDw                    ; call LCD sub-routine with value stored in w
06A6   2???               M         call    LCDdata
                      01644 
06A7   300A           01645         movlw   b'00001010'     ; check amount of 10s
06A8   00A9           01646         movwf   TEMP2           ; Sub-LO
06A9   01A8           01647         clrf    TEMP3           ; Sub-HI is zero
06AA   2???           01648         call    _VALcnv16       ; call conversion sub-routine
                      01649         LCDw                    ; call LCD sub-routine with value stored in w
06AB   2???               M         call    LCDdata
                      01650 
06AC   3001           01651         movlw   b'00000001'     ; check amount of 1s
06AD   00A9           01652         movwf   TEMP2           ; Sub-LO
06AE   01A8           01653         clrf    TEMP3           ; Sub-HI is zero
06AF   16AC           01654         bsf     BCflag          ; remove blank checker in case of zero
06B0   2???           01655         call    _VALcnv16       ; call conversion sub-routine
                      01656         LCDw                    ; call LCD sub-routine with value stored in w
06B1   2???               M         call    LCDdata
                      01657  
06B2   0008           01658         RETURN
                      01659 
                      01660 
                      01661 ;*****************************************************
                      01662 
                      01663 
06B3                  01664 LCDval32
                      01665  
                      01666  
06B3   12AC           01667    bcf BCflag
06B4   3080           01668    movlw 0x80
06B5   00A9           01669    movwf TEMP2
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06B6   3096           01670    movlw 0x96
06B7   00A8           01671    movwf TEMP3
06B8   3098           01672    movlw 0x98
06B9   00AA           01673    movwf TEMP4
06BA   01AB           01674    clrf TEMP5
06BB   2???           01675    call _Valcnv32
06BC   2???           01676    call LCDdata
06BD   16AC           01677    bsf BCflag
                      01678 
06BE   3040           01679    movlw 0x40
06BF   00A9           01680    movwf TEMP2
06C0   3042           01681    movlw 0x42
06C1   00A8           01682    movwf TEMP3
06C2   300F           01683    movlw 0x0f
06C3   00AA           01684    movwf TEMP4
06C4   01AB           01685    clrf TEMP5
06C5   2???           01686    call _Valcnv32
06C6   2???           01687    call LCDdata
                      01688 
06C7   302C           01689    movlw ','
06C8   2???           01690    call LCDdata
                      01691 
06C9   30A0           01692    movlw 0xa0
06CA   00A9           01693    movwf TEMP2
06CB   3086           01694    movlw 0x86
06CC   00A8           01695    movwf TEMP3
06CD   3001           01696    movlw 0x01
06CE   00AA           01697    movwf TEMP4
06CF   01AB           01698    clrf TEMP5
06D0   2???           01699    call _Valcnv32
06D1   2???           01700    call LCDdata
                      01701 
06D2   3010           01702    movlw 0x10
06D3   00A9           01703    movwf TEMP2
06D4   3027           01704    movlw 0x27
06D5   00A8           01705    movwf TEMP3
06D6   01AA           01706    clrf TEMP4
06D7   01AB           01707    clrf TEMP5
06D8   2???           01708    call _Valcnv32
06D9   2???           01709    call LCDdata
                      01710 
                      01711  ;  movlw 0xe8
                      01712  ;  movwf TEMP2
                      01713  ;  movlw 0x03
                      01714  ;  movwf TEMP3
                      01715  ;  clrf TEMP4
                      01716  ;  clrf TEMP5
                      01717  ;  call _Valcnv32
                      01718  ;  call LCDdata
                      01719 
                      01720  ;  movlw 0x64
                      01721  ;  movwf TEMP2
                      01722  ;  clrf TEMP3
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01723  ;  clrf TEMP4
                      01724  ;  clrf TEMP5
                      01725  ;  call _Valcnv32
                      01726  ;  call LCDdata
                      01727 
                      01728  ;  movlw 0x0a
                      01729  ;  movwf TEMP2
                      01730  ;  clrf TEMP3
                      01731  ;  clrf TEMP4
                      01732  ;  clrf TEMP5
                      01733  ;  call _Valcnv32
                      01734  ;  call LCDdata
                      01735 
                      01736  ;  movlw 0x01
                      01737  ;  movwf TEMP2
                      01738  ;  clrf TEMP3
                      01739  ;  clrf TEMP4
                      01740  ;  clrf TEMP5
                      01741  ;  call _Valcnv32
                      01742  ;  call LCDdata
                      01743  
06DA   0008           01744    return
                      01745 
                      01746 
                      01747 ;************************************************************************
                      01748 
                      01749 
                      01750     
                      01751 
                      01752 
06DB                  01753 _VALcnv08
06DB   01A7           01754         clrf    TEMP1           ; counter
06DC   0829           01755         movfw   TEMP2           ; decrement-value
06DD   0225           01756 _V08_1  subwf   LO_TEMP,W       ; TEST: LO_TEMP-TEMP2 >= 0 ?
06DE   1C03           01757         skpc            ; btfss STATUS,C skip, if true
06DF   2???           01758         goto    _V08_LCD        ; result negativ, exit
06E0   0AA7           01759         incf    TEMP1,F         ; count
06E1   0829           01760         movfw   TEMP2           ; decrement-value
06E2   02A5           01761         subwf   LO_TEMP,F       ; STORE: LO_TEMP = LO_TEMP - TEMP2
06E3   16AC           01762         bsf     BCflag          ; invalidate flag
06E4   2???           01763         goto    _V08_1          ; repeat
06E5                  01764 _V08_LCD
06E5   3030           01765         movlw   '0'             ; writes Number to LCD
06E6   0727           01766         addwf   TEMP1,W         ; '0' is ascii offset, add counter
06E7   1EAC           01767         btfss   BCflag          ; check flag
06E8   3020           01768         movlw ' '               ; clear preceeding zeros
                      01769         ; return with data in w
06E9   0008           01770         RETURN
                      01771 
                      01772 
                      01773 ;*****************************************************
                      01774 
                      01775 
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

06EA                  01776 _VALcnv16
06EA   01A7           01777         clrf    TEMP1           ; clear counter
06EB   0828           01778 _V16_1  movfw   TEMP3
06EC   0226           01779         subwf   HI_TEMP,w       ; TEST: HI_TEMP-TEMP3 >= 0 ?
06ED   1C03           01780         skpc                    ; skip, if true
06EE   2???           01781         goto    _V16_LCD        ; result negativ, exit
06EF   1D03 2???      01782         bnz     _V16_2          ; test zero, jump if result > 0
06F1   0829           01783         movfw   TEMP2           ; Precondition: HI-TEST is zero
06F2   0225           01784         subwf   LO_TEMP,w       ; TEST: LO_TEMP-TEMP2 >= 0 ?
06F3   1C03           01785         skpc                    ; skip, if true
06F4   2???           01786         goto    _V16_LCD        ; result negativ, exit
06F5                  01787 _V16_2
06F5   0828           01788         movfw   TEMP3
06F6   02A6           01789         subwf   HI_TEMP,f       ; STORE: HI_TEMP = HI_TEMP - TEMP3
06F7   0829           01790         movfw   TEMP2
06F8   02A5           01791         subwf   LO_TEMP,f       ; STORE: LO_TEMP = LO_TEMP - TEMP2
06F9   1C03           01792         skpc                    ; skip, if true
06FA   03A6           01793         decf    HI_TEMP,f       ; decrement HI
06FB   0AA7           01794         incf    TEMP1,f         ; increment counter
06FC   16AC           01795         bsf     BCflag          ; invalidate flag
06FD   2???           01796         goto    _V16_1
06FE                  01797 _V16_LCD
06FE   3030           01798         movlw   '0'             ; writes number to LCD
06FF   0727           01799         addwf   TEMP1,w         ; '0' is ascii offset, add counter
0700   1EAC           01800         btfss   BCflag          ; check flag
0701   3020           01801         movlw   ' '             ; clear preceeding zeros
                      01802         ; return with data in w
0702   0008           01803         RETURN
                      01804 
                      01805 ;********************************************************************
                      01806 
                      01807 
                      01808 
0703                  01809 _Valcnv32
0703   01A7           01810    clrf TEMP1
0704                  01811 _V32_1
0704   082B           01812    movfw TEMP5
0705   0226           01813    subwf HI_TEMP,w
0706   1C03           01814    skpc
0707   2???           01815    goto _V32_LCD
0708   1D03 2???      01816    bnz _V32_2
                      01817 
070A   082A           01818    movfw TEMP4
070B   0225           01819    subwf LO_TEMP,w
070C   1C03           01820    skpc
070D   2???           01821    goto _V32_LCD
070E   1D03 2???      01822    bnz _V32_2
                      01823 
0710   0828           01824    movfw TEMP3
0711   0224           01825    subwf HI,w
0712   1C03           01826    skpc
0713   2???           01827    goto _V32_LCD
0714   1D03 2???      01828    bnz _V32_2
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01829 
0716   0829           01830    movfw TEMP2
0717   0223           01831    subwf LO,w
0718   1C03           01832    skpc
0719   2???           01833    goto _V32_LCD
071A                  01834 _V32_2
071A   082B           01835    movfw TEMP5
071B   02A6           01836    subwf HI_TEMP,f
071C   082A           01837    movfw TEMP4
071D   02A5           01838    subwf LO_TEMP,f
071E   1C03           01839    skpc
071F   03A6           01840    decf HI_TEMP,f
0720   0828           01841    movfw TEMP3
0721   02A4           01842    subwf HI,f
0722   1C03           01843    skpc
0723   03A5           01844    decf LO_TEMP,f
0724   0829           01845    movfw TEMP2
0725   02A3           01846    subwf LO,f
0726   1C03           01847    skpc     ; skeep if carry
0727   03A4           01848    decf HI,f
0728   0AA7           01849    incf TEMP1,f
0729   16AC           01850    bsf BCflag
072A   2???           01851    goto _V32_1
072B                  01852 _V32_LCD
072B   3030           01853    movlw '0'
072C   0727           01854    addwf TEMP1,w
072D   1EAC           01855    btfss BCflag
072E   3020           01856    movlw ' '
072F   0008           01857    return
                      01858 
                      01859 
                      01860 ;*********************************************************************************************
                      01861 
                      01862 
                      01863 
                      01864 ;--------------------------------------------------------------------------
                      01865 
                      01866  
                      01867 
                      01868 ;***** SUBROUTINES *****
                      01869 
                      01870         ; transmit only lower nibble of w
                      01871 
0730   00A1           01872 LCDxmit movwf   LCDbuf          ; store command/data nibble
                      01873         ; first, clear LCD data lines
                      01874         clrLCDport
0731   30F0               M         movlw   b'11110000'     ; get mask
0732   0585               M         andwf   LCDport,f       ; clear data lines only
                      01875         ; second, move data out to LCD data lines
0733   0821           01876         movf    LCDbuf,w        ; get data
0734   390F           01877         andlw   b'00001111'     ; extract only valid part
0735   0485           01878         iorwf   LCDport,f       ; put to LCD data lines
0736   0008           01879         RETURN
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01880 
                      01881 ;***************************************************
                      01882 
                      01883 
                      01884 ;*****************************************************
                      01885 
                      01886 
                      01887         ; clocks LCD data/command
0737                  01888 LCDclk  ;WAIT   LCDWAIT
0737   3004           01889     movlw LCDWAIT
0738   2???           01890     call delay_ms
0739   1605           01891     bsf     LCD_EN              ; set LCD enable
                      01892         ; insert LCDSPEED x nops to comply with manufacturer
                      01893         ; specifications for clock rates above 9 MHz
  0000                01894         VARIABLE CNT_V          ; declare intermediate variable
  00000001            01895 CNT_V = LCDSPEED        ; assign pre-defined constant
                      01896         WHILE (CNT_V > 0x0)     ; perform while loop to insert 'nops'
073A   0000           01897           nop                   ; insert 'nop'
  00000000            01898 CNT_V -= 1              ; decrement
                      01899         ENDW
073B   1205           01900         bcf     LCD_EN
                      01901         WAIT    LCDWAIT         ; clocks LCD data/command
                          M         IF (LCDWAIT     != 0)
073C   3004               M             movlw       LCDWAIT
073D   2???               M             call delay_ms
                          M         ENDIF
073E   0008           01902         RETURN
                      01903 
                      01904 
                      01905 ;*****************************************************
                      01906 
                      01907 
                      01908         ; transmit command to LCD
073F                  01909 LCDcomd
073F   1285           01910     bcf LCD_RS          ; select command registers
0740   2???           01911         goto    _LCD_wr
                      01912 
                      01913         ; transmit data to LCD
0741   1685           01914 LCDdata bsf     LCD_RS          ; select data registers
0742                  01915 _LCD_wr ;       bcf     LCD_RW          ; set write direction
0742   00A2           01916         movwf   LCDtemp         ; store command/data to send
                      01917         ; send hi-nibble
                      01918 ;       movfw   LCDtemp         ; get data
0743   0E22           01919         swapf   LCDtemp,w       ; swap hi- and lo-nibble, store in w
0744   2???           01920         call    LCDxmit         ; transmit nibble
0745   2???           01921         call    LCDclk
                      01922         ; send lo-nibble
0746   0822           01923         movfw   LCDtemp         ; get data
0747   2???           01924         call    LCDxmit         ; transmit nibble
0748   2???           01925         call    LCDclk
                      01926         ; reset LCD controls
                      01927         clrLCDport              ; reset LCD data lines
0749   30F0               M         movlw   b'11110000'     ; get mask
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

074A   0585               M         andwf   LCDport,f       ; clear data lines only
074B   1285           01928         bcf     LCD_RS          ; reset command/data register
074C   0008           01929         RETURN
                      01930 
                      01931 ;*****************************************************
                      01932 
074D                  01933 LCDinit
074D   1205           01934         bcf     LCD_EN          ; clear LCD clock line
074E   1285           01935         bcf     LCD_RS          ; clear command/data line
                      01936         clrLCDport              ; reset LCD data lines
074F   30F0               M         movlw   b'11110000'     ; get mask
0750   0585               M         andwf   LCDport,f       ; clear data lines only
                      01937         WAIT    4*LCDWAIT       ; >= 40 ms 
                          M         IF (4*LCDWAIT   != 0)
0751   3010               M             movlw       4*LCDWAIT
0752   2???               M             call delay_ms
                          M         ENDIF
                      01938 
                      01939         ; LCD INITIALIZATION STARTS HERE
                      01940         ; start in 8 bit mode
0753   3003           01941         movlw   LCDEM8          ; send b'0011' on [DB7:DB4]
0754   2???           01942         call    LCDxmit         ; start in 8 bit mode 
0755   2???           01943         call    LCDclk          ; That's while: Wait 39us
                      01944         WAIT    LCDWAIT         ; On POWER UP, the LCD will initialize itself,
                          M         IF (LCDWAIT     != 0)
0756   3004               M             movlw       LCDWAIT
0757   2???               M             call delay_ms
                          M         ENDIF
                      01945                                 ; but after a RESET of the microcontroller without
                      01946                                 ; POWER OFF, the 8 bit function mode will reboot
                      01947                                 ; the LCD to 4 bit mode safely.
                      01948 
0758   3008           01949         movlw   LCDDZ           ; set DDRAM to zero
0759   2???           01950         call    LCDxmit
075A   2???           01951         call    LCDclk
                      01952         WAIT    LCDWAIT         ; ~1 ms @ 4 MHz
                          M         IF (LCDWAIT     != 0)
075B   3004               M             movlw       LCDWAIT
075C   2???               M             call delay_ms
                          M         ENDIF
                      01953 
075D   3002           01954         movlw   LCDEM4          ; send b'0010' on [DB7:DB4]
075E   2???           01955         call    LCDxmit         ; change to 4 bit mode
075F   2???           01956         call    LCDclk
                      01957         WAIT    LCDWAIT         ; ~1 ms @ 4 MHz
                          M         IF (LCDWAIT     != 0)
0760   3004               M             movlw       LCDWAIT
0761   2???               M             call delay_ms
                          M         ENDIF
                      01958 
                      01959         ; now in 4 bit mode, sending two nibbles
                      01960         IF LCDTYPE == 0x00
                      01961           LCDcmd LCD2L          ; function set: 4 bit mode, 2 lines, 5x7 dots
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01962           LCDcmd LCDCONT        ; display control: display on, cursor off, blinking off
                      01963           LCDcmd LCDCLR         ; clear display, address counter to zero
                      01964           WAIT LCDCLRWAIT       ; wait after LCDCLR until LCD is ready again
                      01965         ELSE
                      01966           IF LCDTYPE == 0x01
                      01967             ; for LCD EA DIP204-4 (white chars, blue backlight)
                      01968             LCDcmd LCD2L_A      ; switch on extended function set
0762   302C               M         movlw   LCD2L_A
0763   2???               M         call    LCDcomd
                      01969              LCDcmd LCDEXT      ; 4 lines
0764   3009               M         movlw   LCDEXT
0765   2???               M         call    LCDcomd
                      01970              LCDcmd LCD2L_B     ; switch off extended function set
0766   3028               M         movlw   LCD2L_B
0767   2???               M         call    LCDcomd
                      01971             LCDcmd LCDCONT      ; display control: display on, cursor off, blinking off
0768   300C               M         movlw   LCDCONT
0769   2???               M         call    LCDcomd
                      01972             LCDcmd LCDCLR       ; clear display, address counter to zero
076A   3001               M         movlw   LCDCLR
076B   2???               M         call    LCDcomd
                      01973             WAIT LCDCLRWAIT     ; wait after LCDCLR until LCD is ready again
                          M         IF (LCDCLRWAIT  != 0)
076C   3008               M             movlw       LCDCLRWAIT
076D   2???               M             call delay_ms
                          M         ENDIF
                      01974           ELSE
                      01975             ERROR "Unsupported parameter"
                      01976           ENDIF
                      01977         ENDIF
076E   0008           01978     return
                      01979 
                      01980 
                      01981 
                      01982 
                      01983 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      01984 
                      01985 
076F                  01986 delay_ms            ; W*1ms  at 4MHz
076F   00B3           01987     movwf delay_mult
0770                  01988 del_20m             ; 20ms
                      01989 
0770   30C8           01990     movlw  d'200'
0771   00B5           01991     movwf delay_k200
                      01992 ;   clrwdt
0772                  01993 del_2u
0772   0000           01994     nop
0773   0000           01995     nop
0774   0000           01996     nop
0775   0BB5           01997     decfsz delay_k200,f
0776   2???           01998     goto del_2u
                      01999 
0777   0BB3           02000     decfsz delay_mult,f
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0778   2???           02001     goto del_20m
0779   0008           02002     return
                      02003 
                      02004 
                      02005 ;*****************************************
                      02006 
                      02007 
                      02008 ;**********************************************************************************************
                      02009 
                      02010  
                      02011  
                      02012  
                      02013 
                      02014 
                      02015  
                      02016 
                      02017 
                      02018 ;****************************************************
                      02019 
                      02020 
                      02021 
                      02022       cblock 0x30
                      02023        
  00000030            02024 bIntSaveSt       
  00000031            02025 bIntSaveFSR            
  00000032            02026 bIntSavePCLATH    
                      02027  
                      02028 
                      02029 
                      02030 
  00000033            02031 delay_mult   
  00000034            02032 delay_k50    
  00000035            02033 delay_k200    
                      02034 
                      02035  
                      02036 
  00000036            02037 bGenFlags1       ; general control flags 1
  00000037            02038 bCnt            ; work byte conter
                      02039 
                      02040 ; Timer1
  00000038            02041 iTimer1:2       
  0000003A            02042 bGenClk       
  0000003B            02043 bXmitClk     
                      02044 
  0000003C            02045 iA2DValue:2
  0000003E            02046 bRegAddr
  0000003F            02047 bRegData 
                      02048  
                      02049 
  00000040            02050 iRecID_L         ; ID of receiver message( 3 bits left justified)
  00000041            02051 iRecID_H        ; ID of receiver message( 8 bits left justified) 
  00000042            02052 iRecEX_H
  00000043            02053 iRecEX_L
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  00000044            02054 bRecCount        ; number of bytes received
  00000045            02055 pRecDataBase:8  
                      02056  
                      02057  
                      02058 
                      02059    ;; Low level SPI interface
  0000004D            02060 b2510RegAdr     ; 0x50
  0000004E            02061 b2510RegData   
  0000004F            02062 b2510RegMask   
                      02063 
                      02064    ;; used in interrupt
  00000050            02065 bSPICnt        ; # bytes remaining to receive
  00000051            02066 pSPIBuf         ; Pointer into buffer
  00000052            02067 pSPIBufBase:16        ; 0x55 Base of SPI receive/xmit buffer
                      02068 
                      02069  
  00000062            02070 CanType        ;  0x65
  00000063            02071 IntCAN_Err
  00000064            02072 SaveReg
  00000065            02073 cdata
  00000066            02074 cbit
  00000067            02075 cIdx
                      02076   
                      02077  endc
                      02078 
  0000007F            02079 bIntSaveW0 equ 0x7F
  000000FF            02080 bIntSaveW1 equ 0xFF 
                      02081 
                      02082 
                      02083 
                      02084          
                      02085  
3F71                  02086      END
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 74


SYMBOL TABLE
  LABEL                             VALUE 

ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ADCON0                            0000001F
ADCON1                            0000009F
ADCS0                             00000006
ADCS1                             00000007
ADCS2                             00000006
ADDEN                             00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADON                              00000000
ADRESH                            0000001E
ADRESL                            0000009E
AdjFw                             000005A2
AdjRew                            00000589
BANK0                             
BANK1                             
BASE                              00000020
BCLIE                             00000003
BCLIF                             00000003
BCflag                            LCDFLAGreg,0x05
BF                                00000000
BFPCTRL                           0x0C
BRGH                              00000002
BitMod2510                        000000B9
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CANCTRL                           0x0F
CANCTRL1                          0x1F
CANCTRL2                          0x2F
CANCTRL3                          0x3F
CANCTRL4                          0x4F
CANCTRL5                          0x5F
CANCTRL6                          0x6F
CANCTRL7                          0x7F
CANINTE                           0x2B
CANINTF                           0x2C
CANSTAT                           0x0E
CANSTAT1                          0x1E
CANSTAT2                          0x2E
CANSTAT3                          0x3E
CANSTAT4                          0x4E
CANSTAT5                          0x5E
CANSTAT6                          0x6E
CANSTAT7                          0x7E
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 75


SYMBOL TABLE
  LABEL                             VALUE 

CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCP2CON                           0000001D
CCP2IE                            00000000
CCP2IF                            00000000
CCP2M0                            00000000
CCP2M1                            00000001
CCP2M2                            00000002
CCP2M3                            00000003
CCP2X                             00000005
CCP2Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CCPR2H                            0000001C
CCPR2L                            0000001B
CHS0                              00000003
CHS1                              00000004
CHS2                              00000005
CIS                               00000003
CKE                               00000006
CKP                               00000004
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000009C
CMIE                              00000006
CMIF                              00000006
CNF1                              0x2A
CNF2                              0x29
CNF3                              0x28
CNT_V                             00000000
CREN                              00000004
CSRC                              00000007
CVR0                              00000000
CVR1                              00000001
CVR2                              00000002
CVR3                              00000003
CVRCON                            0000009D
CVREN                             00000007
CVROE                             00000006
CVRR                              00000005
CanType                           00000062
CfgExMask                         00000600
CfgFunc                           00000556
CfgSTDMask                        000005E7
CheckCANMsg                       0000001F
D                                 00000005
DATA_ADDRESS                      00000005
DC                                00000001
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 76


SYMBOL TABLE
  LABEL                             VALUE 

D_A                               00000005
EEADR                             0000010D
EEADRH                            0000010F
EECON1                            0000018C
EECON2                            0000018D
EEDATA                            0000010C
EEDATH                            0000010E
EEIE                              00000004
EEIF                              00000004
EEPGD                             00000007
EFLG                              0x2D
ExchangeSPI                       00000121
F                                 00000001
FALSE                             00000000
FERR                              00000002
FSR                               00000004
FXTAL                             4
GCEN                              00000007
GIE                               00000007
GO                                00000002
GO_DONE                           00000002
Get2510Status                     0000009A
GetSRegAddr                       00000300
GetStrAddr                        00000313
HI                                00000024
HI_TEMP                           00000026
HardStart                         00000149
I2C_DATA                          00000005
I2C_READ                          00000002
I2C_START                         00000003
I2C_STOP                          00000004
INDEX                             0000002E
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
Init                              000001BD
Init1                             00000508
Init2510aa                        000000DD
InitIO                            000001D9
InitSPIBuf                        00000107
InitSPIPort                       000000D4
IntCAN_Err                        00000063
IntReturn                         00000015
IntSPI                            00000136
Key_Down                          000005A8
Key_Enter                         000005D5
Key_Left                          00000583
Key_Right                         0000059A
Key_Up                            000005BE
LCD2L                             00000028
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 77


SYMBOL TABLE
  LABEL                             VALUE 

LCD2L_A                           0000002C
LCD2L_B                           00000028
LCDCH                             00000002
LCDCL                             00000004
LCDCLR                            00000001
LCDCLRWAIT                        00000008
LCDCONT                           0000000C
LCDCR                             00000006
LCDDZ                             00000008
LCDEM4                            00000002
LCDEM8                            00000003
LCDEXT                            00000009
LCDFLAGreg                        0000002C
LCDL1                             00000080
LCDL2                             000000C0
LCDL3                             00000094
LCDL4                             000000D4
LCDLINENUM                        00000004
LCDMCL                            00000010
LCDMCR                            00000014
LCDSL                             00000018
LCDSPEED                          00000001
LCDSR                             0000001C
LCDTYPE                           00000001
LCDText                           00000642
LCDWAIT                           00000004
LCD_CGAdr                         
LCD_DDAdr                         
LCD_EN                            PORTA,0x04
LCD_Hex                           00000653
LCD_RS                            PORTA,0x05
LCD_RegString                     00000631
LCDbuf                            00000021
LCDclk                            00000737
LCDcmd                            
LCDcomd                           0000073F
LCDdata                           00000741
LCDinit                           0000074D
LCDport                           00000005
LCDtemp                           00000022
LCDtris                           00000085
LCDval08                          00000680
LCDval16                          00000691
LCDval32                          000006B3
LCDw                              
LCDxmit                           00000730
LO                                00000023
LO_TEMP                           00000025
LoadSPIByte                       00000115
LoadSPIZeros                      00000118
MCP2515_ISR                       00000131
NOT_A                             00000005
NOT_ADDRESS                       00000005
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 78


SYMBOL TABLE
  LABEL                             VALUE 

NOT_BO                            00000000
NOT_BOR                           00000000
NOT_DONE                          00000002
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_RC8                           00000006
NOT_T1SYNC                        00000002
NOT_TO                            00000004
NOT_TX8                           00000006
NOT_W                             00000002
NOT_WRITE                         00000002
OERR                              00000001
OPTION_REG                        00000081
OldLATH                           00000020
P                                 00000004
PAGE0                             
PAGE1                             
PCFG0                             00000000
PCFG1                             00000001
PCFG2                             00000002
PCFG3                             00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PEN                               00000002
PIE1                              0000008C
PIE1_P                            0000008C
PIE2                              0000008D
PIR1                              0000000C
PIR2                              0000000D
PORTA                             00000005
PORTB                             00000006
PORTC                             00000007
PR2                               00000092
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
ParseCAN                          000001AA
ParseKey                          0000017A
ParseKey1                         00000196
ProccessSPI                       0000010C
R                                 00000002
RBIE                              00000003
RBIF                              00000000
RC8_9                             00000006
RC9                               00000006
RCD8                              00000000
RCEN                              00000003
RCIE                              00000005
RCIF                              00000005
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 79


SYMBOL TABLE
  LABEL                             VALUE 

RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
READ_WRITE                        00000002
REC                               0x1D
RP0                               00000005
RP1                               00000006
RSEN                              00000001
RTS0                              0x01
RTS1                              0x02
RTS2                              0x04
RX9                               00000006
RX9D                              00000000
RXB0CTRL                          0x60
RXB0D0                            0x66
RXB0D1                            0x67
RXB0D2                            0x68
RXB0D3                            0x69
RXB0D4                            0x6A
RXB0D5                            0x6B
RXB0D6                            0x6C
RXB0D7                            0x6D
RXB0DLC                           0x65
RXB0EID0                          0x64
RXB0EID8                          0x63
RXB0SIDH                          0x61
RXB0SIDL                          0x62
RXB1CTRL                          0x70
RXB1D0                            0x76
RXB1D1                            0x77
RXB1D2                            0x78
RXB1D3                            0x79
RXB1D4                            0x7A
RXB1D5                            0x7B
RXB1D6                            0x7C
RXB1D7                            0x7D
RXB1DLC                           0x75
RXB1EID0                          0x74
RXB1EID8                          0x73
RXB1SIDH                          0x71
RXB1SIDL                          0x72
RXF0EID0                          0x03
RXF0EID8                          0x02
RXF0SIDH                          0x00
RXF0SIDL                          0x01
RXF1EID0                          0x07
RXF1EID8                          0x06
RXF1SIDH                          0x04
RXF1SIDL                          0x05
RXF2EID0                          0x0B
RXF2EID8                          0x0A
RXF2SIDH                          0x08
RXF2SIDL                          0x09
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 80


SYMBOL TABLE
  LABEL                             VALUE 

RXF3EID0                          0x13
RXF3EID8                          0x12
RXF3SIDH                          0x10
RXF3SIDL                          0x11
RXF4EID0                          0x17
RXF4EID8                          0x16
RXF4SIDH                          0x14
RXF4SIDL                          0x15
RXF5EID0                          0x1B
RXF5EID8                          0x1A
RXF5SIDH                          0x18
RXF5SIDL                          0x19
RXM0EID0                          0x23
RXM0EID8                          0x22
RXM0SIDH                          0x20
RXM0SIDL                          0x21
RXM1EID0                          0x27
RXM1EID8                          0x26
RXM1SIDH                          0x24
RXM1SIDL                          0x25
R_W                               00000002
Rd2510Reg                         000000A2
Refresh                           00000564
RegNames                          00000400
Reset2510                         000000CE
Rts2510                           000000C6
S                                 00000003
SEN                               00000000
SMP                               00000007
SPBRG                             00000099
SPEN                              00000007
SPI_BitMod                        
SPI_Read                          
SPI_Rts                           
SPI_WriteL                        
SPI_WriteV                        
SPI_WriteW                        
SREN                              00000005
SSPADD                            00000093
SSPBUF                            00000013
SSPCON                            00000014
SSPCON2                           00000091
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPOV                             00000006
SSPSTAT                           00000094
STATUS                            00000003
STR_NUM                           0000002D
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 81


SYMBOL TABLE
  LABEL                             VALUE 

SYNC                              00000004
SaveReg                           00000064
Set1HClock                        
Set2510Mode                       0000007A
SetConfigMode                     00000054
SetListenMode                     00000086
SetLoopBackMode                   0000006D
SetNormalMode                     00000061
Str0                              0000031F
Str1                              00000329
Str2                              00000338
Str3                              0000034D
Str4                              00000355
Str5                              00000362
Str6                              0000036E
Str7                              0000037C
Str8                              00000389
Str9                              00000396
Strings                           0000031E
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1INSYNC                          00000002
T1OSCEN                           00000003
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TEC                               0x1C
TEMP1                             00000027
TEMP2                             00000029
TEMP3                             00000028
TEMP4                             0000002A
TEMP5                             0000002B
TMR0                              00000001
TMR0IE                            00000005
TMR0IF                            00000002
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 82


SYMBOL TABLE
  LABEL                             VALUE 

TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRISC                             00000087
TRMT                              00000001
TRUE                              00000001
TX8_9                             00000006
TX9                               00000006
TX9D                              00000000
TXB0CTRL                          0x30
TXB0D0                            0x36
TXB0D1                            0x37
TXB0D2                            0x38
TXB0D3                            0x39
TXB0D4                            0x3A
TXB0D5                            0x3B
TXB0D6                            0x3C
TXB0D7                            0x3D
TXB0DLC                           0x35
TXB0EID0                          0x34
TXB0EID8                          0x33
TXB0SIDH                          0x31
TXB0SIDL                          0x32
TXB1CTRL                          0x40
TXB1D0                            0x46
TXB1D1                            0x47
TXB1D2                            0x48
TXB1D3                            0x49
TXB1D4                            0x4A
TXB1D5                            0x4B
TXB1D6                            0x4C
TXB1D7                            0x4D
TXB1DLC                           0x45
TXB1EID0                          0x44
TXB1EID8                          0x43
TXB1SIDH                          0x41
TXB1SIDL                          0x42
TXB2CTRL                          0x50
TXB2D0                            0x56
TXB2D1                            0x57
TXB2D2                            0x58
TXB2D3                            0x59
TXB2D4                            0x5A
TXB2D5                            0x5B
TXB2D6                            0x5C
TXB2D7                            0x5D
TXB2DLC                           0x55
TXB2EID0                          0x54
TXB2EID8                          0x53
TXB2SIDH                          0x51
TXB2SIDL                          0x52
TXD8                              00000000
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 83


SYMBOL TABLE
  LABEL                             VALUE 

TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXRTSCTRL                         0x0D
TXSTA                             00000098
UA                                00000001
W                                 00000000
WAIT                              
WCOL                              00000007
WR                                00000001
WREN                              00000002
WRERR                             00000003
WaitANDeqZ                        00000093
WaitMSec                          000001E6
WaitSPIExchange                   0000012D
Wrt2510Reg                        000000AE
Z                                 00000002
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_C                                STATUS,0
_CCP1IE_P                         PIE1_P,CCP1IE
_CCP1IF                           PIR1,CCP1IF
_CPD_OFF                          00003FFF
_CPD_ON                           00003EFF
_CP_ALL                           00001FFF
_CP_OFF                           00003FFF
_DC                               STATUS,1
_DEBUG_OFF                        00003FFF
_DEBUG_ON                         000037FF
_HS_OSC                           00003FFE
_Hex08                            00000671
_INTE                             INTCON,INTE
_INTF                             INTCON,INTF
_IRP                              STATUS,7
_LCD_wr                           00000742
_LP_OSC                           00003FFC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_PD                               STATUS,3
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_RBIE                             INTCON,RBIE
_RBIF                             INTCON,RBIF
_RCIE_P                           PIE1_P,RCIE
_RCIF                             PIR1,RCIF
_RC_OSC                           00003FFF
_RP0                              STATUS,5
_RP1                              STATUS,6
_SSPEN                            SSPCON,SSPEN
_SSPIE_P                          PIE1_P,SSPIE
_SSPIF                            PIR1,SSPIF
_T0IE                             INTCON,T0IE
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 84


SYMBOL TABLE
  LABEL                             VALUE 

_T0IF                             INTCON,T0IF
_TMR1IE_P                         PIE1_P,TMR1IE
_TMR1IF                           PIR1,TMR1IF
_TMR2IE_P                         PIE1_P,TMR2IE
_TMR2IF                           PIR1,TMR2IF
_TO                               STATUS,4
_TXIE_P                           PIE1_P,TXIE
_TXIF                             PIR1,TXIF
_V08_1                            000006DD
_V08_H                            00000673
_V08_LCD                          000006E5
_V16_1                            000006EB
_V16_2                            000006F5
_V16_LCD                          000006FE
_V32_1                            00000704
_V32_2                            0000071A
_V32_LCD                          0000072B
_VALcnv08                         000006DB
_VALcnv16                         000006EA
_VH8_LCD                          0000067B
_Valcnv32                         00000703
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_WRT_1FOURTH                      00003BFF
_WRT_256                          00003DFF
_WRT_HALF                         000039FF
_WRT_OFF                          00003FFF
_XT_OSC                           00003FFD
_Z                                STATUS,2
__16F876A                         00000001
__DEBUG                           1
b2510RegAdr                       0000004D
b2510RegData                      0000004E
b2510RegMask                      0000004F
bCnt                              00000037
bGenClk                           0000003A
bGenFlags1                        00000036
bIntSaveFSR                       00000031
bIntSavePCLATH                    00000032
bIntSaveSt                        00000030
bIntSaveW0                        0000007F
bIntSaveW1                        000000FF
bL2bV                             
bRecCount                         00000044
bRegAddr                          0000003E
bRegData                          0000003F
bSPICnt                           00000050
bV2bV                             
bXmitClk                          0000003B
baudrate_flag                     CanType, 1
brdone                            00000526
cIdx                              00000067
cbit                              00000066
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 85


SYMBOL TABLE
  LABEL                             VALUE 

cdata                             00000065
clrLCDport                        
config_mode                       CanType,5
d2510BitMod                       0x05
d2510RTS                          0x80
d2510Rd                           0x03
d2510Reset                        0xC0
d2510Status                       0xA0
d2510Wrt                          0x02
dRelease                          00000000
dVersion                          00000001
data_nibble                       CanType,6
del_20m                           00000770
del_2u                            00000772
delay_k200                        00000035
delay_k50                         00000034
delay_ms                          0000076F
delay_mult                        00000033
disableInt                        
done                              00000641
done1                             00000652
enableInt                         
ertx_flag                         CanType,4
frametype_flag                    CanType,0
getCH                             00000660
getRegAddr                        00000570
iA2DValue                         0000003C
iRecEX_H                          00000042
iRecEX_L                          00000043
iRecID_H                          00000041
iRecID_L                          00000040
iTimer1                           00000038
intInc                            
jCANFrameData                     00000549
jInitClr1                         000001C6
jInitClr2                         000001CC
jIntSPI2                          00000140
jIntTimer0                        00000144
jIntTimer1                        00000146
jMainLoop                         00000164
jRecStd                           00000175
jRxChk11                          0000003D
jRxChk90                          0000004C
jSendFrame                        000004FD
jSet2510M1                        0000007F
jSetConfigM1                      0000005A
jSetListenM1                      0000008C
jSetLoopBackM1                    00000073
jSetNormalM1                      00000067
jStdFrame                         00000036
jWaitANDeqZ                       00000094
jWaitMSec0                        000001E7
jWaitMSec1                        000001EB
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 86


SYMBOL TABLE
  LABEL                             VALUE 

jlow                              0000051A
jmp1HDone                         
jmp1HNotYet                       
jmpC                              
jmpClr                            
jmpFeqF                           
jmpFeqL                           
jmpFeqZ                           
jmpFgeL                           
jmpFgtL                           
jmpFleF                           
jmpFleL                           
jmpFltF                           
jmpFltL                           
jmpFneF                           
jmpFneL                           
jmpFneZ                           
jmpNC                             
jmpNZ                             
jmpSet                            
jmpWeqF                           
jmpWeqL                           
jmpWeqZ                           
jmpWgeF                           
jmpWgeL                           
jmpWgtF                           
jmpWgtL                           
jmpWleF                           
jmpWleL                           
jmpWltF                           
jmpWltL                           
jmpWneF                           
jmpWneL                           
jmpWneZ                           
jmpZ                              
kkLCD_Text                        
menu_stage                        CanType,7
next                              00000637
next1                             0000064A
normal_func                       0000058F
p1                                00000154
pRecDataBase                      00000045
pSPIBuf                           00000051
pSPIBufBase                       00000052
reg0                              00000401
reg1                              0000040F
reg10                             0000048D
reg11                             0000049B
reg12                             000004A9
reg13                             000004B7
reg14                             000004C5
reg15                             000004D3
reg16                             000004E1
MPASM  5.37                          OBD2.ASM   8-9-2018  17:59:35         PAGE 87


SYMBOL TABLE
  LABEL                             VALUE 

reg17                             000004EF
reg2                              0000041D
reg3                              0000042B
reg4                              00000439
reg5                              00000447
reg6                              00000455
reg7                              00000463
reg8                              00000471
reg9                              0000047F
skipC                             
skipClr                           
skipFeqF                          
skipFeqL                          
skipFeqZ                          
skipFneF                          
skipFneL                          
skipFneZ                          
skipNC                            
skipNZ                            
skipSet                           
skipWeqZ                          
skipWneZ                          
skipZ                             
tb2Nottb                          
tb2tb                             
tbNewSPI                          bGenFlags1,2
tbRC2NowHigh                      bGenFlags1,5
tbReset                           bGenFlags1,1
tbRxMsgPend                       bGenFlags1,3
tbTxMsg                           bGenFlags1,4
tbWork                            bGenFlags1,0
toggle                            
tp2510_CS_                        PORTC,2
waitK                             0000017F
waitK1                            0000019B
wrmode3                           000005AF
wrmode4                           000005C6

Errors   :     0
Warnings :     0 reported,     4 suppressed
Messages :     8 reported,    11 suppressed

